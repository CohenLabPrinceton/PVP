

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pvp.common.loggers &mdash; PVP 0.2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/pvp_theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/_static/pvp_theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/pvp_logo_favicon.png"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> PVP
          

          
            
            <img src="../../../_static/pvp_logo_only.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">System Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Hardware:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware_overview.html">Hardware Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware_sensors.html">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware_actuators.html">Actuators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware_electronics.html">Electronics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware_enclosure.html">Enclosure</a></li>
</ul>
<p class="caption"><span class="caption-text">Software:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../software_overview.html">Software Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gui.html">GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../controller.html">Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">Common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io.html">I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../alarm.html">Alarm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coordinator.html">Coordinator</a></li>
</ul>
<p class="caption"><span class="caption-text">Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../requirements.html">Ventilator Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasheets.html">Datasheets &amp; Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../specs.html">Specifications</a></li>
</ul>
<p class="caption"><span class="caption-text">Meta:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog/index.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../buildthedocs.html">Building the Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example_markdown.html">Markdown Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../meta_index.html">Index</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PVP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pvp.common.loggers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pvp.common.loggers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Logging functionality</span>

<span class="sd">There are two types of loggers:</span>

<span class="sd">* :func:`.loggers.init_logger` creates a standard :class:`logging.Logger` -based logging system for debugging and recording system events, and a</span>
<span class="sd">* :class:`.loggers.DataLogger` - a :mod:`tables` - based class to store continuously measured sensor values.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="k">import</span> <span class="n">handlers</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tables</span> <span class="k">as</span> <span class="nn">pytb</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># only import when type checking to avoid cyclical imports</span>
    <span class="c1"># from pvp.common.message import SensorValues, ControlValues, ControlSetting</span>
    <span class="kn">from</span> <span class="nn">pvp.common.message</span> <span class="k">import</span> <span class="n">SensorValues</span><span class="p">,</span> <span class="n">ControlValues</span><span class="p">,</span> <span class="n">DerivedValues</span><span class="p">,</span> <span class="n">ControlSetting</span>


<span class="kn">from</span> <span class="nn">pvp.common</span> <span class="k">import</span> <span class="n">prefs</span>

<span class="n">_LOGGERS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">list of strings, which loggers have been created already.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="init_logger"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.init_logger">[docs]</a><span class="k">def</span> <span class="nf">init_logger</span><span class="p">(</span><span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">log_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">file_handler</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a logger for logging events.</span>

<span class="sd">    To keep logs sensible, you should usually initialize the logger with the name of the module that&#39;s using it, eg::</span>

<span class="sd">        logger = init_logger(__name__)</span>

<span class="sd">    If a logger has already been initialized (ie. its name is in :data:`.loggers._LOGGERS`, return that.</span>

<span class="sd">    otherwise configure and return the logger such that</span>

<span class="sd">    * its ``LOGLEVEL`` is set to ``prefs.LOGLEVEL``</span>
<span class="sd">    * It formats logging messages with logger name, time, and logging level</span>
<span class="sd">    * if a file handler is specified (default), create a :class:`logging.RotatingFileHandler` according to params set in ``prefs``</span>

<span class="sd">    Args:</span>
<span class="sd">        module_name (str): module name used to generate filename and name logger</span>
<span class="sd">        log_level (int): one of :var:`logging.DEBUG`, :var:`logging.INFO`, :var:`logging.WARNING`, or :var:`logging.ERROR`</span>
<span class="sd">        file_handler (bool, str): if ``True``, (default), log in ``&lt;logdir&gt;/module_name.log`` .</span>
<span class="sd">            if ``False``, don&#39;t log to disk.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`logging.Logger` : Logger 4 u 2 use</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

    <span class="c1"># if the logger has already been created, return the same instance</span>
    <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;_LOGGERS&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">logger</span>

    <span class="c1"># set log level</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">log_level</span><span class="p">:</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;LOGLEVEL&#39;</span><span class="p">)</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">log_level</span><span class="p">)</span>


    <span class="k">assert</span> <span class="n">log_level</span> <span class="ow">in</span> <span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                         <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                         <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
                         <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># I assume this is to stop printing to stderr? why does it get a formatter then? -jls 2020-05-25</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

    <span class="c1"># handler to log to disk</span>
    <span class="c1"># max = 8 file x 16 MB = 128 MB</span>
    <span class="k">if</span> <span class="n">file_handler</span> <span class="ow">and</span> <span class="s1">&#39;pytest&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="n">log_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;LOG_DIR&#39;</span><span class="p">),</span>
                                    <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span>
            <span class="n">log_filename</span><span class="p">,</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
            <span class="n">maxBytes</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;LOGGING_MAX_BYTES&#39;</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;_LOGGERS&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;LOGGING_MAX_FILES&#39;</span><span class="p">)),</span>
            <span class="n">backupCount</span><span class="o">=</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;LOGGING_MAX_FILES&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;_LOGGERS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

    <span class="c1"># update the maxBytes of each logger so the same total maxBytes is kept</span>
    <span class="n">update_logger_sizes</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">logger</span></div>

<div class="viewcode-block" id="update_logger_sizes"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.update_logger_sizes">[docs]</a><span class="k">def</span> <span class="nf">update_logger_sizes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjust each logger&#39;s ``maxBytes`` attribute so that the total across all loggers is ``prefs.LOGGING_MAX_BYTES``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_max_bytes</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;LOGGING_MAX_BYTES&#39;</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;_LOGGERS&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;LOGGING_MAX_FILES&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">logger_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;_LOGGERS&#39;</span><span class="p">]:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">):</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">maxBytes</span> <span class="o">=</span> <span class="n">new_max_bytes</span></div>


<span class="k">class</span> <span class="nc">ContinuousData</span><span class="p">(</span><span class="n">pytb</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structure for the hdf5-table for continuous waveform data; measured once per controller loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timestamp</span>    <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># current time of the measurement - has to be 64 bit</span>
    <span class="n">pressure</span>     <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
    <span class="n">flow_out</span>     <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
    <span class="n">control_in</span>   <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
    <span class="n">control_out</span>  <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
    <span class="n">oxygen</span>       <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>
    <span class="n">cycle_number</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">UInt32Col</span><span class="p">()</span>     <span class="c1"># Max is 2147483647 Breath Cycles (~78 years)</span>


<span class="k">class</span> <span class="nc">ControlCommand</span><span class="p">(</span><span class="n">pytb</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structure for the hdf5-table to store control commands. Appended whenever a control command is received.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span>      <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">StringCol</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>   <span class="c1"># Control setting name</span>
    <span class="n">value</span>     <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># double (double-precision)</span>
    <span class="n">min_value</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># double (double-precision)</span>
    <span class="n">max_value</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># double (double-precision)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># double (double-precision)</span>

<span class="k">class</span> <span class="nc">CycleData</span><span class="p">(</span><span class="n">pytb</span><span class="o">.</span><span class="n">IsDescription</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structure for the hdf5-table to store derived quantities from waveform measurements. Measured once per breath-cycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timestamp</span>        <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># Start time of this breath cycle</span>
    <span class="n">cycle_number</span>     <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">UInt32Col</span><span class="p">()</span>     <span class="c1"># Index of this breath cycle, Max is 2147483647 Breath Cycles (~78 years)</span>
    <span class="n">I_phase_duration</span> <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># estimated duration of inspiratory phase</span>
    <span class="n">pip_time</span>         <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># estimated time when peak inspiratory pressure [PIP] was reached</span>
    <span class="n">peep_time</span>        <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># estimated time when positive end-expiratory pressure [PEEP] was reached</span>
    <span class="n">pip</span>              <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># estimated peak inspiration pressure [PIP]</span>
    <span class="n">pip_plateau</span>      <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># estimated plateau pressure around PIP</span>
    <span class="n">peep</span>             <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># estimated peep pressure</span>
    <span class="n">vte</span>              <span class="o">=</span>  <span class="n">pytb</span><span class="o">.</span><span class="n">Float64Col</span><span class="p">()</span>    <span class="c1"># estimated End-Tidal Volume</span>

<div class="viewcode-block" id="DataLogger"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger">[docs]</a><span class="k">class</span> <span class="nc">DataLogger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for logging numerical respiration data and control settings.</span>
<span class="sd">    Creates a hdf5 file with this general structure:</span>
<span class="sd">        / root</span>
<span class="sd">        |--- waveforms (group)</span>
<span class="sd">        |    |--- time | pressure_data | flow_out | control_signal_in | control_signal_out | FiO2 | Cycle No.</span>
<span class="sd">        |</span>
<span class="sd">        |--- controls (group)</span>
<span class="sd">        |    |--- (time, controllsignal)</span>
<span class="sd">        |</span>
<span class="sd">        |--- derived_quantities (group)</span>
<span class="sd">        |    |--- (time, Cycle No, I_PHASE_DURATION, PIP_TIME, PEEP_time, PIP, PIP_PLATEAU, PEEP, VTE )</span>
<span class="sd">        |</span>
<span class="sd">        |</span>

<span class="sd">    Public Methods:</span>
<span class="sd">        close_logfile():                      Flushes, and closes the logfile.</span>
<span class="sd">        store_waveform_data(SensorValues):    Takes data from SensorValues, but DOES NOT FLUSH</span>
<span class="sd">        store_controls():                     Store controls in the same file? TODO: Discuss</span>
<span class="sd">        flush_logfile():                      Flush the data into the file</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DataLogger.__init__"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compression_level</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialized the coontinuous numerical logger class.</span>

<span class="sd">        Args:</span>
<span class="sd">            compression_level (int, optional): Compression level of the hdf5 file. Defaults to 9.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Logging the start of the DataLogger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">init_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;DataLogger init&#39;</span><span class="p">)</span>

        <span class="c1"># general parameters for logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MAX_FILE_SIZE</span> <span class="o">=</span> <span class="mf">1e8</span>          <span class="c1"># Maximum allowed file size for circular logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MAX_NUM_LOGFILES</span> <span class="o">=</span> <span class="mi">10</span>        <span class="c1"># Maximum allowed file number for circular logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_save_allowed</span> <span class="o">=</span> <span class="kc">True</span>     <span class="c1"># Data is allowed to be saved. If exceeds limits above, the flag is set to False, and logging stops.</span>

        <span class="c1"># If initialized, make a new file</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="n">date_string</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%H-%M&quot;</span><span class="p">)</span>

        <span class="c1"># Make the log folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;DATA_DIR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">date_string</span> <span class="o">+</span> <span class="s2">&quot;_controller_log.0.h5&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure that the file doesn&#39;t exist yet, if it does, append another number</span>
        <span class="c1"># In rarely happens, but for Travis-tests, this is needed.</span>
        <span class="n">c</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">date_string</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_controller_log.0.h5&quot;</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_files</span><span class="p">()</span>  <span class="c1"># Make sure there is space. Sum of all logfiles in bytes</span>

        <span class="c1">## For data storage ##</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>      <span class="c1"># Open logfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression_level</span> <span class="o">=</span> <span class="n">compression_level</span> <span class="c1"># From 1 to 9, see tables documentation</span></div>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_logfile</span><span class="p">()</span>

<div class="viewcode-block" id="DataLogger._open_logfile"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger._open_logfile">[docs]</a>    <span class="k">def</span> <span class="nf">_open_logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens the hdf5 file and generates the file structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">isopen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reopening &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;/waveforms&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating /waveform table in: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s1">&#39;waveforms&#39;</span><span class="p">,</span> <span class="s1">&#39;Respiration waveforms&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;readout&#39;</span><span class="p">,</span> <span class="n">ContinuousData</span><span class="p">,</span> <span class="s2">&quot;Breath Cycles&quot;</span><span class="p">,</span>
                                                       <span class="n">filters</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span>
                                                           <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compression_level</span><span class="p">,</span>
                                                           <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">),</span>
                                                       <span class="n">expectedrows</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">waveforms</span><span class="o">.</span><span class="n">readout</span>

        <span class="k">if</span> <span class="s2">&quot;/controls&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating /controls table in: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s1">&#39;controls&#39;</span><span class="p">,</span> <span class="s1">&#39;Control signal history&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;readout&#39;</span><span class="p">,</span> <span class="n">ControlCommand</span><span class="p">,</span> <span class="s2">&quot;Control Commands&quot;</span><span class="p">,</span>
                                                          <span class="n">filters</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span>
                                                              <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compression_level</span><span class="p">,</span>
                                                              <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
                                                          <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">readout</span>

        <span class="k">if</span> <span class="s2">&quot;/derived_quantities&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating /derived_quantities table in: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s1">&#39;derived_quantities&#39;</span><span class="p">,</span> <span class="s1">&#39;Quantities derived from waveform, one per cycle&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">derived_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;readout&#39;</span><span class="p">,</span> <span class="n">CycleData</span><span class="p">,</span> <span class="s2">&quot;Derived Values&quot;</span><span class="p">,</span>
                                                          <span class="n">filters</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span>
                                                              <span class="n">complevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compression_level</span><span class="p">,</span>
                                                              <span class="n">complib</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">)</span>
                                                          <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">derived_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">derived_quantities</span><span class="o">.</span><span class="n">readout</span></div>

<div class="viewcode-block" id="DataLogger.close_logfile"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.close_logfile">[docs]</a>    <span class="k">def</span> <span class="nf">close_logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flushes &amp; closes the open hdf file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving in...&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Also flushes the remaining buffers</span></div>

<div class="viewcode-block" id="DataLogger.store_waveform_data"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.store_waveform_data">[docs]</a>    <span class="k">def</span> <span class="nf">store_waveform_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_values</span><span class="p">:</span> <span class="s1">&#39;SensorValues&#39;</span><span class="p">,</span> <span class="n">control_values</span><span class="p">:</span> <span class="s1">&#39;ControlValues&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a datapoint to the file for continuous logging of streaming data.</span>
<span class="sd">        NOTE: Not flushed yet.</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_values (SensorValues): SensorValues to be stored in the file.</span>
<span class="sd">            control_values (ControlValues): ControlValues to be stored in the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_save_allowed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_logfile</span><span class="p">()</span>
            <span class="n">datapoint</span>                 <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_table</span><span class="o">.</span><span class="n">row</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">sensor_values</span><span class="o">.</span><span class="n">timestamp</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">sensor_values</span><span class="o">.</span><span class="n">PRESSURE</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;flow_out&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">sensor_values</span><span class="o">.</span><span class="n">FLOWOUT</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;control_in&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">control_values</span><span class="o">.</span><span class="n">control_signal_in</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;control_out&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">control_values</span><span class="o">.</span><span class="n">control_signal_out</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;oxygen&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">sensor_values</span><span class="o">.</span><span class="n">FIO2</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;cycle_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensor_values</span><span class="o">.</span><span class="n">breath_count</span>
            <span class="n">datapoint</span><span class="o">.</span><span class="n">append</span><span class="p">()</span></div>

<div class="viewcode-block" id="DataLogger.store_control_command"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.store_control_command">[docs]</a>    <span class="k">def</span> <span class="nf">store_control_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_setting</span><span class="p">:</span> <span class="s1">&#39;ControlSetting&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a datapoint to the event-table, derived from ControlSettings</span>

<span class="sd">        Args:</span>
<span class="sd">            control_setting (ControlSetting): ControlSettings object, the content of which should be stored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_save_allowed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_logfile</span><span class="p">()</span>
            <span class="n">datapoint</span>               <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_table</span><span class="o">.</span><span class="n">row</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;min_value&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">min_value</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;max_value&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">timestamp</span>
            <span class="n">datapoint</span><span class="o">.</span><span class="n">append</span><span class="p">()</span></div>

<div class="viewcode-block" id="DataLogger.store_derived_data"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.store_derived_data">[docs]</a>    <span class="k">def</span> <span class="nf">store_derived_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">derived_values</span><span class="p">:</span> <span class="s1">&#39;DerivedValues&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a datapoint to the event-table, derived the continuous data (PIP, PEEP etc.)</span>

<span class="sd">        Args:</span>
<span class="sd">            derived_values (DerivedValues): DerivedValues object, the content of which should be stored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_save_allowed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_logfile</span><span class="p">()</span>
            <span class="n">datapoint</span>                      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derived_table</span><span class="o">.</span><span class="n">row</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">timestamp</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;cycle_number&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">breath_count</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;I_phase_duration&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">I_phase_duration</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;pip_time&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">pip_time</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;peep_time&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">peep_time</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;pip&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">pip</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;pip_plateau&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">pip_plateau</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;peep&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">peep</span>
            <span class="n">datapoint</span><span class="p">[</span><span class="s1">&#39;vte&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">derived_values</span><span class="o">.</span><span class="n">vte</span>
            <span class="n">datapoint</span><span class="o">.</span><span class="n">append</span><span class="p">()</span></div>

<div class="viewcode-block" id="DataLogger.flush_logfile"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.flush_logfile">[docs]</a>    <span class="k">def</span> <span class="nf">flush_logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This flushes the datapoints to the file.</span>
<span class="sd">        To be executed every other second, e.g. at the end of breath cycle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_save_allowed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_table</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_table</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="DataLogger.check_files"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.check_files">[docs]</a>    <span class="k">def</span> <span class="nf">check_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make sure that the file&#39;s are not getting too large.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">):</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span>
            <span class="c1"># skip if it is symbolic link</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="ow">and</span> <span class="n">fp</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">):</span>
                <span class="n">total_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="c1">#Check file system</span>
        <span class="n">total_space_hd</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">free</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">max_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">total_space_hd</span><span class="o">*</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">])</span>      <span class="c1"># Limit to whatever is smaller, 20% of the file system or 10 GB</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Too many logfiles in </span><span class="si">{self.log_dir}</span><span class="s1"> (&gt;1000 files). There are &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39; files. Delete some.&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="c1"># self.logger.exception(message)  # Log a warning</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_save_allowed</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Stop data saving</span>
        <span class="k">elif</span> <span class="n">total_size</span><span class="o">&gt;</span><span class="n">max_size</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Logfiles in </span><span class="si">{self.log_dir}</span><span class="s1"> are too large. Max allowed is &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_size</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;GB, used is &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_size</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span> <span class="o">+</span>  <span class="s1">&#39;GB. Free disk space.&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>  <span class="c1"># Log a warning</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_save_allowed</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Stop data saving</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_save_allowed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Allow data saving</span>
            <span class="k">return</span> <span class="n">total_size</span>  <span class="c1"># size in bytes</span></div>

<div class="viewcode-block" id="DataLogger.rotation_newfile"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.rotation_newfile">[docs]</a>    <span class="k">def</span> <span class="nf">rotation_newfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This rotates through filenames, similar to a ringbuffer, to make sure that the program does not run of of space/</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logfile_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>                       <span class="c1"># Measure active logfile &quot;..._log.0.h5&quot;</span>

        <span class="k">if</span> <span class="n">logfile_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAX_FILE_SIZE</span><span class="p">:</span>                          <span class="c1"># If too big:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_logfile</span><span class="p">()</span>                                        <span class="c1"># Close current logfile</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.0.&quot;</span><span class="p">)</span>                              <span class="c1"># Go through all logfiles, and increase idx;  &quot;..._log.0.h5&quot; -&gt; &quot;..._log.1.h5&quot; etc</span>
            <span class="k">for</span> <span class="n">file_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_NUM_LOGFILES</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>    <span class="c1"># Have to start at index of last allowed file</span>
                <span class="n">old_filename</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_idx</span>    <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_filename</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old_filename</span><span class="p">):</span>                        <span class="c1"># On only if logfile already exists</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_filename</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                                         <span class="c1"># Generate new file with right file structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_logfile</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;DataLogger: rotated to new file.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataLogger.load_file"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.load_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This loads a hdf5 file, and returns data to the user as a dictionary with two keys: waveform_data and control_data</span>


<span class="sd">        Args:</span>
<span class="sd">            filename (str, optional): Path to a hdf5-file. If none is given, uses currently open file. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dictionary: Containing the data arranged as ` {&quot;waveform_data&quot;: waveform_data, &quot;control_data&quot;: control_data, &quot;derived_data&quot;: derived_data}`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_logfile</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading... &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pytb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">waveforms</span><span class="o">.</span><span class="n">readout</span>
            <span class="n">waveform_data</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">readout</span>
            <span class="n">control_data</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">derived_quantities</span><span class="o">.</span><span class="n">readout</span>
            <span class="n">derived_data</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;waveform_data&quot;</span><span class="p">:</span> <span class="n">waveform_data</span><span class="p">,</span> <span class="s2">&quot;control_data&quot;</span><span class="p">:</span> <span class="n">control_data</span><span class="p">,</span> <span class="s2">&quot;derived_data&quot;</span><span class="p">:</span> <span class="n">derived_data</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">data_dict</span></div>

<div class="viewcode-block" id="DataLogger.log2mat"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.log2mat">[docs]</a>    <span class="k">def</span> <span class="nf">log2mat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translates the compressed hdf5 into a matlab file containing a matlab struct. This struct has the same structure as the hdf5 file, but is not compressed.</span>
<span class="sd">        Use for any file:</span>
<span class="sd">            dl = DataLogger()</span>
<span class="sd">            dl.log2mat(filename)</span>
<span class="sd">        The file is saved at the same path as `.mat` file, where the content is represented as matlab-structs.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str, optional): Path to a hdf5-file. If none is given, uses currently open file. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>

        <span class="n">new_file</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;h5&#39;</span><span class="p">)</span>
        <span class="n">new_filename</span> <span class="o">=</span> <span class="n">new_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span>
        <span class="c1"># try:</span>
        <span class="n">dff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">ls_wv</span> <span class="o">=</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;waveform_data&#39;</span><span class="p">]</span>
        <span class="n">ls_dv</span> <span class="o">=</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;derived_data&#39;</span><span class="p">]</span>
        <span class="n">ls_ct</span> <span class="o">=</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;control_data&#39;</span><span class="p">]</span>
        <span class="n">matlab_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;waveforms&#39;</span><span class="p">:</span> <span class="n">ls_wv</span><span class="p">,</span> <span class="s1">&#39;derived_quantities&#39;</span><span class="p">:</span> <span class="n">ls_dv</span><span class="p">,</span> <span class="s1">&#39;control_commands&#39;</span><span class="p">:</span> <span class="n">ls_ct</span><span class="p">}</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">new_filename</span><span class="p">,</span> <span class="n">matlab_data</span><span class="p">)</span></div>
        <span class="c1"># except:</span>
            <span class="c1"># print(filename + &quot; not found.&quot;)</span>


<div class="viewcode-block" id="DataLogger.log2csv"><a class="viewcode-back" href="../../../pvp.common.loggers.html#pvp.common.loggers.DataLogger.log2csv">[docs]</a>    <span class="k">def</span> <span class="nf">log2csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translates the compressed hdf5 into three csv files containing:</span>
<span class="sd">            - waveform_data (measurement once per cycle)</span>
<span class="sd">            - derived_quantities (PEEP, PIP etc.)</span>
<span class="sd">            - control_commands (control commands sent to the controller)</span>

<span class="sd">        This approximates the structure contained in the hdf5 file.</span>
<span class="sd">        Use for any file:</span>
<span class="sd">            dl = DataLogger()</span>
<span class="sd">            dl.log2csv(filename)</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str, optional): Path to a hdf5-file. If none is given, uses currently open file. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
        <span class="n">new_file</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;h5&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">ls_wv</span> <span class="o">=</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;waveform_data&#39;</span><span class="p">]</span>
            <span class="n">ls_dv</span> <span class="o">=</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;derived_data&#39;</span><span class="p">]</span>
            <span class="n">ls_ct</span> <span class="o">=</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;control_data&#39;</span><span class="p">]</span>

            <span class="c1"># Waveform_data</span>
            <span class="n">new_filename</span> <span class="o">=</span> <span class="n">new_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;waveforms&quot;</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ls_wv</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">new_filename</span><span class="p">,</span> <span class="n">ls_wv</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Derived quantities</span>
            <span class="n">new_filename</span> <span class="o">=</span> <span class="n">new_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;derived_quantities&quot;</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ls_dv</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">new_filename</span><span class="p">,</span> <span class="n">ls_dv</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Control Commands</span>
            <span class="n">new_filename</span> <span class="o">=</span> <span class="n">new_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;control_commands&quot;</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ls_ct</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">new_filename</span><span class="p">,</span> <span class="n">ls_ct</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%.18e</span><span class="s1">,</span><span class="si">%.18e</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%.18e</span><span class="s1">,</span><span class="si">%.18e</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot; not found.&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, jonny saunders et al

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>