

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pvp.controller.control_module &mdash; PVP 0.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/pvp_theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/_static/pvp_theme.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> PVP
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../control_overview.html">Control Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Hardware:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware.html">Hardware Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Software:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../controller.html">controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coordinator.html">coordinator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gui.html">GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io.html">io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../alarm.html">alarm</a></li>
</ul>
<p class="caption"><span class="caption-text">Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../requirements.html">Ventilator Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasheets.html">Datasheets &amp; Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../specs.html">Specifications</a></li>
</ul>
<p class="caption"><span class="caption-text">Meta:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog/index.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../buildthedocs.html">Building the Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example_markdown.html">Markdown Example</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PVP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pvp.controller.control_module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pvp.controller.control_module</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
<span class="kn">import</span> <span class="nn">signal</span>

<span class="kn">import</span> <span class="nn">pvp.io</span> <span class="k">as</span> <span class="nn">io</span>

<span class="kn">from</span> <span class="nn">pvp.common.message</span> <span class="kn">import</span> <span class="n">SensorValues</span><span class="p">,</span> <span class="n">ControlValues</span><span class="p">,</span> <span class="n">ControlSetting</span><span class="p">,</span> <span class="n">DerivedValues</span>
<span class="kn">from</span> <span class="nn">pvp.common.loggers</span> <span class="kn">import</span> <span class="n">init_logger</span><span class="p">,</span> <span class="n">DataLogger</span>
<span class="kn">from</span> <span class="nn">pvp.common.values</span> <span class="kn">import</span> <span class="n">CONTROL</span><span class="p">,</span> <span class="n">ValueName</span>
<span class="kn">from</span> <span class="nn">pvp.common.utils</span> <span class="kn">import</span> <span class="n">timeout</span>
<span class="kn">from</span> <span class="nn">pvp.alarm</span> <span class="kn">import</span> <span class="n">ALARM_RULES</span><span class="p">,</span> <span class="n">AlarmType</span><span class="p">,</span> <span class="n">AlarmSeverity</span><span class="p">,</span> <span class="n">Alarm</span>
<span class="kn">from</span> <span class="nn">pvp</span> <span class="kn">import</span> <span class="n">prefs</span>


<div class="viewcode-block" id="ControlModuleBase"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase">[docs]</a><span class="k">class</span> <span class="nc">ControlModuleBase</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Abstract controller class for simulation/hardware.</span>

<span class="sd">    1. General notes:</span>
<span class="sd">    All internal variables fall in three classes, denoted by the beginning of the variable:</span>
<span class="sd">        - `COPY_varname`: These are copies (for safe threading purposes) that are regularly sync&#39;ed with internal variables.</span>
<span class="sd">        - `__varname`:    These are variables only used in the ControlModuleBase-Class</span>
<span class="sd">        - `_varname`:     These are variables used in derived classes.</span>

<span class="sd">    2. Set and get values.</span>
<span class="sd">    Internal variables should only to be accessed though the set_ and get_ functions.</span>
<span class="sd">        These functions act on COPIES of internal variables (`__` and `_`), that are sync&#39;d every few</span>
<span class="sd">        iterations. How often this is done is adjusted by the variable</span>
<span class="sd">        `self._NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE`. To avoid multiple threads manipulating the same</span>
<span class="sd">        variables at the same time, every manipulation of `COPY_` is surrounded by a thread lock.</span>

<span class="sd">    Public Methods:</span>
<span class="sd">        - `get_sensors()`:                     Returns a copy of the current sensor values.</span>
<span class="sd">        - `get_alarms()`:                      Returns a List of all alarms, active and logged</span>
<span class="sd">        - `get_control(ControlSetting)`:       Sets a controll-setting. Is updated at latest within self._NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>
<span class="sd">        - `get_past_waveforms()`:              Returns a List of waveforms of pressure and volume during at the last N breath cycles, N&lt;self. _RINGBUFFER_SIZE, AND clears this archive.</span>
<span class="sd">        - `start()`:                           Starts the main-loop of the controller</span>
<span class="sd">        - `stop()`:                            Stops the main-loop of the controller</span>
<span class="sd">        - `set_control()`:                     Set the control</span>
<span class="sd">        - `interrupt()`:                       Interrupt the controller, and re-spawns the thread. Used to restart a stuck controller</span>
<span class="sd">        - `is_running()`:                      Returns a bool whether the main-thread is running</span>
<span class="sd">        - `get_heartbeat()`:                   Returns a heartbeat, more specifically, the continuously increasing iteration-number of the main control loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ControlModuleBase.__init__"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_logs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">flush_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the ControlModuleBase class.</span>

<span class="sd">        Args:</span>
<span class="sd">            save_logs (bool, optional): Should sensor data and controls should be saved with the :class:`.DataLogger`? Defaults to False.</span>
<span class="sd">            flush_every (int, optional): Flush and rotate logs every n breath cycles. Defaults to 10.</span>

<span class="sd">        Raises:</span>
<span class="sd">            alert: [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">init_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;controller init&#39;</span><span class="p">)</span>

        <span class="c1">#####################  Algorithm/Program parameters  ##################</span>
        <span class="c1"># Hyper-Parameters</span>
        <span class="c1"># TODO: These should probably all (or whichever make sense) should be args to __init__ -jls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span>                   <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;CONTROLLER_LOOP_UPDATE_TIME&#39;</span><span class="p">)</span>    <span class="c1"># Run the main control loop every 0.01 sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;CONTROLLER_LOOPS_UNTIL_UPDATE&#39;</span><span class="p">)</span>  <span class="c1"># After every 10 main control loop iterations, update COPYs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_RINGBUFFER_SIZE</span>                    <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;CONTROLLER_RINGBUFFER_SIZE&#39;</span><span class="p">)</span>     <span class="c1"># Maximum number of breath cycles kept in memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span>                          <span class="o">=</span> <span class="n">save_logs</span>   <span class="c1"># Keep logs in a file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FLUSH_EVERY</span>                        <span class="o">=</span> <span class="n">flush_every</span>

        <span class="c1">#########################  Control management  #########################</span>

        <span class="c1"># This is what the machine has controll over:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span>  <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># State of a valve on the inspiratory side - could be a proportional valve.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># State of a valve on the exspiratory side - this is open/close i.e. value in (0,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_helpers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span> <span class="c1"># Helper variables for multiple low-pass filters</span>

        <span class="c1"># Internal Control variables. &quot;SET&quot; indicates that this is set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span>       <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>                     <span class="c1"># Target PIP pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_GAIN</span>  <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>                <span class="c1"># Target time to reach PIP in seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span>      <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>                    <span class="c1"># Target PEEP pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span> <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>               <span class="c1"># Target time to reach PEEP from PIP plateau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>       <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>      <span class="c1"># Target breaths per minute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>   <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>    <span class="c1"># Target duration of inspiratory phase</span>

        <span class="c1"># Derived internal control variables - fully defined by numbers above</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># TODO: raise alert</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Couldnt set cycle duration, setting to 20. __SET_BPM: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span><span class="si">}</span><span class="se">\n</span><span class="s1">Got exception:</span><span class="se">\n</span><span class="s1">    </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_E_PHASE</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_T_PEEP</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_E_PHASE</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span>

        <span class="c1">#########################  Alarm management  #########################</span>

        <span class="c1"># Alarm management; controller can only react to High airway pressure alarm, and report Hardware problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hapa_crossing_time</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># time that the pressure first crosses the threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># type: typing.List[Alarm]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_hapa</span> <span class="o">=</span> <span class="n">ALARM_RULES</span><span class="p">[</span><span class="n">AlarmType</span><span class="o">.</span><span class="n">HIGH_PRESSURE</span><span class="p">]</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">limit</span> <span class="c1"># TODO: Jonny write method to get limits from alarm manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cough_duration</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;COUGH_DURATION&#39;</span><span class="p">)</span> <span class="c1"># type: typing.Union[float, int]</span>
        <span class="c1">#self.breath_pressure_drop = 4 #prefs.get_pref(&#39;XXXXX&#39;)   #pressure drop below peep that is detected as an attempt to breath.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breath_pressure_drop</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;BREATH_PRESSURE_DROP&#39;</span><span class="p">)</span> <span class="c1"># type: typing.Union[float, int]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breath_detection</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;BREATH_DETECTION&#39;</span><span class="p">)</span> <span class="c1"># type: bool</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">limit_max_flows</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;CONTROLLER_MAX_FLOW&#39;</span><span class="p">)</span>            <span class="c1"># If flows above that, hardware cannot be correct.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_max_pressure</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;CONTROLLER_MAX_PRESSURE&#39;</span><span class="p">)</span>       <span class="c1"># If pressure above that, hardware cannot be correct.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_max_stuck_sensor</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;CONTROLLER_MAX_STUCK_SENSOR&#39;</span><span class="p">)</span>   <span class="c1"># 200 ms, jonny, wherever you want this number to live</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">sensor_stuck_since</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#########################  Data management  #########################</span>

        <span class="c1"># These are measurements from the last breath cycle.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># Measured value of PIP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Measured pressure of the plateau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_TIME</span> <span class="o">=</span> <span class="kc">None</span>    <span class="c1"># Measured time of reaching PIP plateau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span> <span class="o">=</span> <span class="kc">None</span>        <span class="c1"># Measured valued of PEEP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP_TIME</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># Measured time of reaching PEEP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># Measured duration of inspiratory phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_LAST_PEEP</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Last time of PEEP - by definition end of breath cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># Measured breathing rate, by definition 60sec / length_of_breath_cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># Maximum air displacement in last breath cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_P</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># Last measurements of the proportional term for PID-control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># Last measurements of the integral term for PID-control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_D</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># Last measurements of the differential term for PID-control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># Total number of breaths/id of current breath cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_breath_counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span> <span class="c1"># threadsafe counter</span>

        <span class="c1"># Parameters to keep track of breath-cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>                            <span class="c1"># To build up the current cycle&#39;s waveform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RINGBUFFER_SIZE</span><span class="p">)</span>          <span class="c1"># An archive of past waveforms.</span>

        <span class="c1"># These are measurements that change from timepoint to timepoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VOLUME</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_OXYGEN</span>   <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span>  <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># Oxygen is not queried in every cycle. This is a copy of the value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_OXYGEN_LAST_READ</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># Last time the oxygen sensor was read.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span>     <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># Measurement of the airflow out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_dpdt</span>     <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># Current sample of the rate of change of pressure dP/dt in cmH2O/sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_old</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span>   <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_BASELINE_ESTIMATOR_LENGTH</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_PRESSURE_AVEREAGING_LENGTH</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flow_list</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BASELINE_ESTIMATOR_LENGTH</span><span class="p">)</span>          <span class="c1"># An archive of past flows, to calculate background flow out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE_LIST</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PRESSURE_AVEREAGING_LENGTH</span><span class="p">)</span>

        <span class="c1">############### Initialize COPY variables for threads  ##############</span>
        <span class="c1"># COPY variables that later updated on a regular basis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_sensor_values</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># empty SensorValues can no longer be instantiated -jls</span>

        <span class="c1">###########################  Threading init  #########################</span>
        <span class="c1"># Run the start() method as a thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_set_to_COPY</span><span class="p">()</span>

        <span class="c1"># self.__thread = threading.Thread(target=self._start_mainloop, daemon=True)</span>
        <span class="c1"># self.__thread.start()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">############################# Logging ################################</span>
        <span class="c1"># Create an instance of the DataLogger class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dl</span> <span class="o">=</span> <span class="n">DataLogger</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># raised if not enough space</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;couldnt start data logger, not saving logs. Got exception</span><span class="se">\n</span><span class="s1">    </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">####################### Internal health checks ###########################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_critical_time</span>     <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;HEARTBEAT_TIMEOUT&#39;</span><span class="p">)</span>           <span class="c1">#If Controller has not received set/get within the last 200 ms, it gets nervous.</span></div>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Destruction of the ControlModuleBase Class; closes the log-file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">close_logfile</span><span class="p">()</span>

<div class="viewcode-block" id="ControlModuleBase._initialize_set_to_COPY"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase._initialize_set_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_initialize_set_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a copy of internal variables. This is used to facilitate threading</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="c1"># Copy of the SET variables for threading.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP_TIME</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_GAIN</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP_TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_BPM</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span></div>

<div class="viewcode-block" id="ControlModuleBase._sensor_to_COPY"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase._sensor_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_sensor_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># These variables have to come from the hardware</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="c1"># Make sure you have acquire and release!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ControlModuleBase._controls_from_COPY"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase._controls_from_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_controls_from_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Update SET variables</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="c1">#Update values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_GAIN</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP_TIME</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP_TIME</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_BPM</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span>

        <span class="c1">#Update derived values</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>
            <span class="c1">#TODO: raise alert</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_E_PHASE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_T_PEEP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_E_PHASE</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span></div>

    <span class="k">def</span> <span class="nf">__analyze_last_waveform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This goes through the last waveform, and updates the internal variables:</span>
<span class="sd">              VTE, PEEP, PIP, PIP_TIME, I_PHASE, FIRST_PEEP and BPM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Only if there was a previous cycle</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">mean_pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>

            <span class="c1"># get the pressure niveau heuristically (much faster than fitting)</span>
            <span class="c1"># 20/80 percentile of pressure values below/above mean</span>
            <span class="c1"># Assumption: waveform is mostly between both plateaus</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mean_pressure</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span> <span class="n">pressure</span> <span class="o">&lt;</span> <span class="n">mean_pressure</span><span class="p">],</span> <span class="mi">20</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span> <span class="n">pressure</span> <span class="o">&gt;</span> <span class="n">mean_pressure</span><span class="p">],</span> <span class="mi">80</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span> <span class="n">pressure</span> <span class="o">&gt;</span> <span class="n">mean_pressure</span><span class="p">],</span> <span class="mi">95</span> <span class="p">)</span>             <span class="c1">#PIP is defined as the maximum, here 95% to account for outliers</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_TIME</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span><span class="o">*</span><span class="mf">0.9</span><span class="p">))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP_TIME</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pressure</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span><span class="o">*</span><span class="mf">0.9</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_TIME</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP_TIME</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># and measure the breaths per minute</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span> <span class="o">=</span> <span class="mf">60.</span> <span class="o">/</span> <span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 60 sec divided by the duration of last waveform, exception if this was 0.</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Couldnt calculate BPM, phase was </span><span class="si">{</span><span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">. setting as nan&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
                <span class="c1">#And the control value instance</span>
                <span class="n">derived_values</span> <span class="o">=</span> <span class="n">DerivedValues</span><span class="p">(</span>
                    <span class="n">timestamp</span>        <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                    <span class="n">breath_count</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span><span class="p">,</span>
                    <span class="n">I_phase_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span><span class="p">,</span>
                    <span class="n">pip_time</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_TIME</span><span class="p">,</span>
                    <span class="n">peep_time</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP_TIME</span><span class="p">,</span>
                    <span class="n">pip</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span><span class="p">,</span>
                    <span class="n">pip_plateau</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span><span class="p">,</span>
                    <span class="n">peep</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">,</span> 
                    <span class="n">vte</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span>
                <span class="p">)</span>
                <span class="c1">#And save both</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">store_derived_data</span><span class="p">(</span><span class="n">derived_values</span><span class="p">)</span>

<div class="viewcode-block" id="ControlModuleBase.get_sensors"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.get_sensors">[docs]</a>    <span class="k">def</span> <span class="nf">get_sensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SensorValues</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A method callable from the outside to get a copy of sensorValues</span>

<span class="sd">        Returns:</span>
<span class="sd">            SensorValues: A set of current sensorvalues, handeled by the controller.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure to return a copy of the instance</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COPY_sensor_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cp</span></div>

<div class="viewcode-block" id="ControlModuleBase.get_alarms"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.get_alarms">[docs]</a>    <span class="k">def</span> <span class="nf">get_alarms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Alarm</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A method callable from the outside to get a copy of the alarms, that the controller checks:</span>
<span class="sd">        High airway pressure, and technical alarms.</span>

<span class="sd">        Returns:</span>
<span class="sd">            typing.Union[None, typing.Tuple[Alarm]]: A tuple of alarms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">hapa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span>
            <span class="n">techa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span>

        <span class="c1"># return a tuple of alarms if there are any.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hapa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">techa</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">hapa</span><span class="p">,</span> <span class="n">techa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hapa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">hapa</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">techa</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">techa</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Returning alarms </span><span class="si">{</span><span class="n">ret</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="ControlModuleBase.set_control"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.set_control">[docs]</a>    <span class="k">def</span> <span class="nf">set_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_setting</span><span class="p">:</span> <span class="n">ControlSetting</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A method callable from the outside to set alarms.</span>
<span class="sd">        This updates the entries of COPY with new control values.</span>

<span class="sd">        Args:</span>
<span class="sd">            control_setting (ControlSetting): [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
                <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP_TIME</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
                <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
                <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_BPM</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
                <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
                <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP_TIME</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP_TIME</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not set control </span><span class="si">{</span><span class="n">control_setting</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">, no corresponding variable in controller&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">store_control_command</span><span class="p">(</span><span class="n">control_setting</span><span class="p">)</span>

        <span class="c1"># PIP will pass the HAPA limit in the max_value parameter</span>
        <span class="k">if</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">limit_hapa</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase.get_control"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.get_control">[docs]</a>    <span class="k">def</span> <span class="nf">get_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_setting_name</span><span class="p">:</span> <span class="n">ValueName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ControlSetting</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A method callable from the outside to get current control settings.</span>
<span class="sd">        This returns values of COPY to the outside world.</span>

<span class="sd">        Args:</span>
<span class="sd">            control_setting_name (ValueName): The specific control asked for</span>

<span class="sd">        Returns:</span>
<span class="sd">            ControlSetting: ControlSettings-Object that contains relevant data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">:</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">:</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP_TIME</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">:</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">:</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_BPM</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">:</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP_TIME</span><span class="p">:</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP_TIME</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Could not get control </span><span class="si">{</span><span class="n">control_setting_name</span><span class="si">}</span><span class="s1">, no corresponding variable in controller&#39;</span><span class="p">)</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">return_value</span></div>

<div class="viewcode-block" id="ControlModuleBase.set_breath_detection"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.set_breath_detection">[docs]</a>    <span class="k">def</span> <span class="nf">set_breath_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">breath_detection</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">breath_detection</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">breath_detection</span> <span class="o">!=</span> <span class="n">breath_detection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting breath detection mode to </span><span class="si">{</span><span class="n">breath_detection</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">breath_detection</span> <span class="o">=</span> <span class="n">breath_detection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dont know how to set breath detection mode </span><span class="si">{</span><span class="n">breath_detection</span><span class="si">}</span><span class="s2">, must be bool&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__get_PID_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ytarget</span><span class="p">,</span> <span class="n">yis</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">RC</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the three terms for PID control. Also takes a timestep &quot;dt&quot; on which the integral-term is smoothed.</span>

<span class="sd">        Args:</span>
<span class="sd">            ytarget (float): target value of pressure</span>
<span class="sd">            yis (float): current value of pressure</span>
<span class="sd">            dt (float): timestep</span>
<span class="sd">            RC (float): time constant for calculation of integral term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_new</span> <span class="o">=</span> <span class="n">ytarget</span> <span class="o">-</span> <span class="n">yis</span>                                      <span class="c1"># New value of the error</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">+</span> <span class="n">RC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span> <span class="o">+</span> <span class="n">s</span><span class="o">*</span><span class="p">(</span><span class="n">error_new</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span><span class="p">)</span>     <span class="c1"># Integral term on some timescale RC  -- TODO: Improvement: add integral windup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_D</span> <span class="o">=</span> <span class="n">error_new</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_P</span> <span class="o">=</span> <span class="n">error_new</span>

    <span class="k">def</span> <span class="nf">__calculate_control_signal_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the PID control signal by:</span>
<span class="sd">            - Combining the the three gain parameters.</span>
<span class="sd">            - And smoothing the control signal with a moving window of three frames (~10ms)</span>

<span class="sd">        Args:</span>
<span class="sd">            dt (float): timestep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">new_value</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_value</span> <span class="o">+=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__KP</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_P</span>
        <span class="n">new_value</span> <span class="o">+=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__KI</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span>
        <span class="n">new_value</span> <span class="o">+=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__KD</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_D</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_helpers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_helpers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_helpers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_helpers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_helpers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_helpers</span><span class="p">)</span>

<div class="viewcode-block" id="ControlModuleBase._get_control_signal_in"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase._get_control_signal_in">[docs]</a>    <span class="k">def</span> <span class="nf">_get_control_signal_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produces the INSPIRATORY control-signal that has been calculated in `__calculate_control_signal_in(dt)`</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: the numerical control signal for the inspiratory prop valve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span></div>

<div class="viewcode-block" id="ControlModuleBase._get_control_signal_out"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase._get_control_signal_out">[docs]</a>    <span class="k">def</span> <span class="nf">_get_control_signal_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produces the EXPIRATORY control-signal for the different states, i.e. open/close</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: numerical control signal for expiratory side: open (1) close (0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span></div>

<div class="viewcode-block" id="ControlModuleBase._control_reset"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase._control_reset">[docs]</a>    <span class="k">def</span> <span class="nf">_control_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the internal controller cycle to zero, i.e. restarts the breath cycle.</span>
<span class="sd">        Used for autonomous breath detection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__test_for_alarms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements tests that are to be executed in the main control loop:</span>
<span class="sd">            - Test for HAPA</span>
<span class="sd">            - Test for Technical Alert, making sure sensor values are plausible</span>
<span class="sd">            - Test for Technical Alert, make sure continuous in contact</span>
<span class="sd">        Currently: Alarms are time.time() of first occurance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for now, assume UI will send updates, we init from the default value</span>
        <span class="c1"># jonny will implement means of getting limits from alarm manager</span>
        <span class="c1">#limit_hapa =</span>
        <span class="n">limit_max_flows</span> <span class="o">=</span> <span class="mi">10</span>            <span class="c1"># If flows above that, hardware cannot be correct.</span>
        <span class="n">limit_max_pressure</span> <span class="o">=</span> <span class="mi">100</span>        <span class="c1"># TODO: If pressure above that, hardware cannot be correct. Should find central storge site for hardware limits</span>
        <span class="n">limit_max_stuck_sensor</span> <span class="o">=</span> <span class="mf">0.2</span>    <span class="c1"># TODO: 200 ms, jonny, wherever you want this number to live</span>

        <span class="c1">#### First: Check for High Airway Pressure (HAPA)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_hapa</span><span class="p">:</span>
            <span class="c1"># if just crossing, store time of threshold crossing</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hapa_crossing_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hapa_crossing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># check if time elapsed is greater than cough duration.</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">hapa_crossing_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cough_duration</span><span class="p">:</span>       <span class="c1"># 100 ms active to avoid being triggered by coughs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span> <span class="o">=</span> <span class="mi">30</span>                 <span class="c1"># Default: PIP to 30</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span>  <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># create HAPA alarm</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="o">=</span> <span class="n">Alarm</span><span class="p">(</span><span class="n">AlarmType</span><span class="o">.</span><span class="n">HIGH_PRESSURE</span><span class="p">,</span>
                                      <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
                                      <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                                      <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Triggered HAPA at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Transient high pressure; probably a cough.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hapa_crossing_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#### Second: Check for Technical Alerts via data plausibility:</span>
        <span class="c1">#  -&gt;  Measurements change over time, and are in a plausible range</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_old</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_old</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">]</span>
            <span class="n">inputs_dont_change</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs_dont_change</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_old</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> \
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_old</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> \
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_old</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_old</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">inputs_dont_change</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensor_stuck_since</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sensor_stuck_since</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>                <span class="c1"># If inputs are stuck, remember the time.</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensor_stuck_since</span>   <span class="c1"># If happened again, how long?</span>

            <span class="k">if</span> <span class="n">time_elapsed</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_max_stuck_sensor</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">alarm_type</span> <span class="o">==</span> <span class="n">AlarmType</span><span class="o">.</span><span class="n">SENSORS_STUCK</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alarm</span><span class="p">(</span>
                        <span class="n">AlarmType</span><span class="o">.</span><span class="n">SENSORS_STUCK</span><span class="p">,</span>
                        <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">TECHNICAL</span><span class="p">,</span>
                    <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">alarm_type</span> <span class="o">!=</span> <span class="n">AlarmType</span><span class="o">.</span><span class="n">SENSORS_STUCK</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sensor_stuck_since</span> <span class="o">=</span> <span class="kc">None</span>                           <span class="c1"># If ok, reset sensor_stuck</span>


        <span class="n">data_implausible</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="ow">or</span> \
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_max_flows</span><span class="p">)</span> <span class="ow">or</span> \
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_max_pressure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_implausible</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">alarm_type</span> <span class="o">==</span> <span class="n">AlarmType</span><span class="o">.</span><span class="n">BAD_SENSOR_READINGS</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alarm</span><span class="p">(</span>
                    <span class="n">AlarmType</span><span class="o">.</span><span class="n">BAD_SENSOR_READINGS</span><span class="p">,</span>
                    <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">TECHNICAL</span><span class="p">,</span>
                <span class="p">))</span>

        <span class="c1">#### Third: Make sure that updates are coming in in a regular basis</span>
        <span class="c1">#</span>
        <span class="n">last_contact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">last_contact</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_critical_time</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">alarm_type</span> <span class="o">==</span> <span class="n">AlarmType</span><span class="o">.</span><span class="n">MISSED_HEARTBEAT</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">TECHA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alarm</span><span class="p">(</span>
                    <span class="n">AlarmType</span><span class="o">.</span><span class="n">MISSED_HEARTBEAT</span><span class="p">,</span>
                    <span class="n">AlarmSeverity</span><span class="o">.</span><span class="n">TECHNICAL</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Controller has not heard from coordinator in </span><span class="si">{</span><span class="n">last_contact</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">))</span>

        <span class="c1">#self.TECHA = time.time()  # Technical alert, but continue running hoping for the best</span>

    <span class="k">def</span> <span class="nf">__start_new_breathcycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Some housekeeping. This has to be executed when the next breath cycles starts:</span>
<span class="sd">            - starts new breathcycle</span>
<span class="sd">            - initializes newe __cycle_waveform</span>
<span class="sd">            - analyzes last breath waveform for PIP, PEEP etc. with `__analyze_last_waveform()`</span>
<span class="sd">            - flushes the logfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_breath_counter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VOLUME</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__analyze_last_waveform</span><span class="p">()</span>    <span class="c1"># Analyze last waveform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>            <span class="c1"># Get the fit values from the last waveform directly into sensor values</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FLUSH_EVERY</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">flush_logfile</span><span class="p">()</span>        <span class="c1"># If we kept records, flush the data from the previous breath cycle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">rotation_newfile</span><span class="p">()</span>     <span class="c1"># And Check whether we run out of space for the logger</span>

<div class="viewcode-block" id="ControlModuleBase._PID_update"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase._PID_update">[docs]</a>    <span class="k">def</span> <span class="nf">_PID_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This instantiates the PID control algorithms.</span>
<span class="sd">        During the breathing cycle, it goes through the four states:</span>
<span class="sd">           1) Rise to PIP, speed is controlled by flow (variable: `__SET_PIP_GAIN`)</span>
<span class="sd">           2) Sustain PIP pressure</span>
<span class="sd">           3) Quick fall to PEEP</span>
<span class="sd">           4) Sustaint PEEP pressure</span>
<span class="sd">        Once the cycle is complete, it checks the cycle for any alarms, and starts a new one.</span>
<span class="sd">        A record of pressure/volume waveforms is kept and saved</span>

<span class="sd">        Args:</span>
<span class="sd">            dt (float): timesstep since last update</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cycle_phase</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start</span>
        <span class="n">next_cycle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flow_list</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BASELINE_ESTIMATOR_LENGTH</span><span class="p">:</span>  <span class="c1"># estimate the baseline flow during expiration with a rankfilter</span>
            <span class="n">Qbaseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flow_list</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Qbaseline</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VOLUME</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="o">-</span> <span class="n">Qbaseline</span><span class="p">)</span>      <span class="c1"># Integrate the flow-out to estimate VTE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE_LIST</span><span class="p">)</span>    <span class="c1"># Catch some of the noise, if any.</span>

        <span class="k">if</span> <span class="n">cycle_phase</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__KP</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_GAIN</span><span class="o">-</span><span class="mf">0.95</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__KI</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__KD</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__get_PID_error</span><span class="p">(</span><span class="n">yis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="n">ytarget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_control_signal_in</span><span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span> 

        <span class="k">elif</span> <span class="n">cycle_phase</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span><span class="p">:</span>                                     <span class="c1"># then, we drop pressure to PEEP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flow_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="p">)</span>                                                      <span class="c1"># Keep a list of the flow out of the lung; for baseline e stimation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">1</span>


        <span class="k">elif</span> <span class="n">cycle_phase</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flow_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">5</span><span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span><span class="p">)</span> <span class="o">-</span> <span class="n">cycle_phase</span> <span class="p">))</span> <span class="p">)</span>  <span class="c1"># Make this nice and smooth.</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">breath_detection</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">breath_pressure_drop</span><span class="p">):</span>  <span class="c1">#breath!</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Autonomous breath detected; starting next cycle.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># New cycle starts</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VOLUME</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># ... start at zero volume in the lung</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_dpdt</span>    <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># and restart the rolling average for the dP/dt estimation</span>
                <span class="n">next_cycle</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># New cycle starts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VOLUME</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># ... start at zero volume in the lung</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_dpdt</span>    <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># and restart the rolling average for the dP/dt estimation</span>
            <span class="n">next_cycle</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__test_for_alarms</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">next_cycle</span><span class="p">:</span>                        <span class="c1"># if a new breath cycle has started</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__start_new_breathcycle</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span><span class="p">,</span> <span class="p">[[</span><span class="n">cycle_phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VOLUME</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__save_values</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__save_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to reorganize key parameters in the main PID control loop, into a `SensorValues` object,</span>
<span class="sd">        that can be stored in the logfile, using a method from the DataLogger.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sensor_values</span> <span class="o">=</span>  <span class="n">SensorValues</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="p">{</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">FIO2</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">PRESSURE</span><span class="o">.</span><span class="n">name</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">VTE</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="o">.</span><span class="n">name</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">FLOWOUT</span><span class="o">.</span><span class="n">name</span>              <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span><span class="p">,</span>
        <span class="s1">&#39;timestamp&#39;</span>                         <span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
        <span class="s1">&#39;loop_counter&#39;</span>                      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span><span class="p">,</span>
        <span class="s1">&#39;breath_count&#39;</span>                      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span>
        <span class="p">})</span>

        <span class="c1">#And the control value instance</span>
        <span class="n">control_values</span> <span class="o">=</span> <span class="n">ControlValues</span><span class="p">(</span>
            <span class="n">control_signal_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span><span class="p">,</span>
            <span class="n">control_signal_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1">#And save both</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">store_waveform_data</span><span class="p">(</span><span class="n">sensor_values</span><span class="p">,</span> <span class="n">control_values</span><span class="p">)</span>

<div class="viewcode-block" id="ControlModuleBase.get_past_waveforms"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.get_past_waveforms">[docs]</a>    <span class="k">def</span> <span class="nf">get_past_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Public method to return a list of past waveforms from `__cycle_waveform_archive`.</span>
<span class="sd">        Note: After calling this function, archive is emptied! The format is</span>
<span class="sd">            - Returns a list of [Nx3] waveforms, of [time, pressure, volume]</span>
<span class="sd">            - Most recent entry is waveform_list[-1]</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: [Nx3] waveforms, of [time, pressure, volume]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span> <span class="p">)</span> <span class="c1"># Make sure to return a copy as a list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RINGBUFFER_SIZE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">archive</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">archive</span></div>

<div class="viewcode-block" id="ControlModuleBase._start_mainloop"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase._start_mainloop">[docs]</a>    <span class="k">def</span> <span class="nf">_start_mainloop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prototype method to start main PID loop. Will depend on simulation or device, specified below.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>   </div>

<div class="viewcode-block" id="ControlModuleBase.start"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to start `_start_mainloop` as a thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>  <span class="c1"># If the previous thread has been stopped, make a new one.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_mainloop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main Loop already running.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ControlModuleBase.stop"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to stop the main loop thread, and close the logfile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main Loop is not running.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>               <span class="c1"># If we kept records, flush the data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">close_logfile</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase.interrupt"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.interrupt">[docs]</a>    <span class="k">def</span> <span class="nf">interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the controller seems stuck, this generates a new thread, and starts the main loop.</span>
<span class="sd">        No parameters have changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># try to clear existing threading event first to kill thread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># try releasing existing lock first in case it was stuck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># make new threading objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>           <span class="c1"># New thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;tried to kill thread and failed&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_mainloop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>
            <span class="c1">#TODO RAISE ALERT FOR UI</span>

<div class="viewcode-block" id="ControlModuleBase.is_running"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.is_running">[docs]</a>    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Public Method to assess whether the main loop thread is running.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Return true if and only if the main thread of controller is running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># TODO: this should be better thread-safe variable</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase.get_heartbeat"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleBase.get_heartbeat">[docs]</a>    <span class="k">def</span> <span class="nf">get_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an independent heart-beat of the controller, i.e. the internal loop counter incremented in `_start_mainloop`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: exact value of `self._loop_counter`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_last_contact</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span></div></div>

<div class="viewcode-block" id="ControlModuleDevice"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleDevice">[docs]</a><span class="k">class</span> <span class="nc">ControlModuleDevice</span><span class="p">(</span><span class="n">ControlModuleBase</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses ControlModuleBase to control the hardware.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Implement ControlModuleBase functions</span>
<div class="viewcode-block" id="ControlModuleDevice.__init__"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleDevice.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_logs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">flush_every</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">config_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the ControlModule for the physical system. Inherits methods from ControlModuleBase</span>

<span class="sd">        Args:</span>
<span class="sd">            save_logs (bool, optional): Should logs be kept? Defaults to True.</span>
<span class="sd">            flush_every (int, optional): How often are log-files to be flushed, in units of main-loop-itertions? Defaults to 10.</span>
<span class="sd">            config_file (str, optional): Path to device config file, e.g. &#39;pvp/io/config/dinky-devices.ini&#39;. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ControlModuleBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_logs</span><span class="p">,</span> <span class="n">flush_every</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Hal</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>

        <span class="c1"># Current settings of the valves to avoid unneccesary hardware queries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_setting_ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">setpoint_ex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_setting_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">setpoint_in</span></div>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Destructor for the ControlModuleDevice class. Resets valves to standby, and closes log-files (via `ControlModuleBase`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_valves_standby</span><span class="p">()</span>           <span class="c1"># First set valves to default</span>
        <span class="n">ControlModuleBase</span><span class="o">.</span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>     <span class="c1"># and del the base</span>

<div class="viewcode-block" id="ControlModuleDevice._sensor_to_COPY"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleDevice._sensor_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_sensor_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies the current measurements to`COPY_sensor_values`, so that it can be queried</span>
<span class="sd">        from the outside.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_HAL</span><span class="p">()</span> <span class="c1">#Update sensor measurements</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">COPY_sensor_values</span> <span class="o">=</span> <span class="n">SensorValues</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="p">{</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">FIO2</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">PRESSURE</span><span class="o">.</span><span class="n">name</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">VTE</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="o">.</span><span class="n">name</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">FLOWOUT</span><span class="o">.</span><span class="n">name</span>              <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span><span class="p">,</span>
              <span class="s1">&#39;timestamp&#39;</span>                         <span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
              <span class="s1">&#39;loop_counter&#39;</span>                      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span><span class="p">,</span>
              <span class="s1">&#39;breath_count&#39;</span>                      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span>
          <span class="p">})</span></div>
            
    <span class="c1"># @timeout  #TODO: find a save setting for timeout, as the hardware is kinda slow. &gt;10ms?</span>
<div class="viewcode-block" id="ControlModuleDevice._set_HAL"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleDevice._set_HAL">[docs]</a>    <span class="k">def</span> <span class="nf">_set_HAL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valve_open_in</span><span class="p">,</span> <span class="n">valve_open_out</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set Controls with HAL, decorated with a timeout.</span>

<span class="sd">        As hardware communication is the speed bottleneck. this code is slightly optimized in so far as only changes are sent to hardware.</span>

<span class="sd">        Args:</span>
<span class="sd">            valve_open_in (float): setting of the inspiratory valve; should be in range [0,100]</span>
<span class="sd">            valve_open_out (float): setting of the expiratory valve; should be 1/0 (open and close)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_setting_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">valve_open_in</span><span class="p">)),</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">setpoint_in</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">valve_open_in</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_setting_in</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">valve_open_in</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_setting_ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">valve_open_out</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_setting_ex</span> <span class="o">=</span> <span class="n">valve_open_out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">setpoint_ex</span> <span class="o">=</span>  <span class="n">valve_open_out</span></div>

    <span class="c1"># @timeout</span>
<div class="viewcode-block" id="ControlModuleDevice._get_HAL"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleDevice._get_HAL">[docs]</a>    <span class="k">def</span> <span class="nf">_get_HAL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get sensor values from HAL, decorated with timeout.</span>
<span class="sd">        As hardware communication is the speed bottleneck. this code is slightly optimized in so far as some sensors are</span>
<span class="sd">        queried only in certain phases of the breatch cycle. This is done to run the primary PID loop as fast as possible:</span>

<span class="sd">            - pressure is always queried</span>
<span class="sd">            - Flow is queried only outside of inspiration</span>
<span class="sd">            - In addition, oxygen is only read every 5 seconds.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inspiration_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">pressure</span> <span class="p">)</span>             <span class="c1"># Append pressure to list -&gt; is averaged over a couple values</span>
                
        <span class="k">if</span> <span class="n">inspiration_phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span>         <span class="o">=</span> <span class="mi">0</span>                                  <span class="c1"># Flow out and oxygen are not measured</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_DATA_OXYGEN</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_OXYGEN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OXYGEN_LAST_READ</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>                 <span class="c1"># If the time has come, get an oxygen value.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_OXYGEN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">oxygen</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_OXYGEN_LAST_READ</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">flow_ex</span><span class="o">/</span><span class="mi">60</span>                        <span class="c1"># Get a flow reading in l/sec</span></div>


<div class="viewcode-block" id="ControlModuleDevice.set_valves_standby"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleDevice.set_valves_standby">[docs]</a>    <span class="k">def</span> <span class="nf">set_valves_standby</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This returns valves back to normal setting (in: closed, out: open)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Valves to stand-by.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valve settings back to stand-by.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_HAL</span><span class="p">(</span><span class="n">valve_open_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">valve_open_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Defined state to make sure that it does not pop up.</span></div>

<div class="viewcode-block" id="ControlModuleDevice._start_mainloop"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleDevice._start_mainloop">[docs]</a>    <span class="k">def</span> <span class="nf">_start_mainloop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the main loop. This method should be run as a thread (see the `start()` method in `ControlModuleBase`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MainLoop: start&#39;</span><span class="p">)</span>

        <span class="n">update_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span>                            <span class="c1"># Time sincle last cycle of main-loop</span>

            <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="o">/</span> <span class="mi">4</span><span class="p">:</span>                                                      <span class="c1"># TODO: RAISE HARDWARE ALARM, no update should be so long</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MainLoop: Update too long: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restarted cycle.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_control_reset</span><span class="p">()</span>
                <span class="c1"># dt = self._LOOP_UPDATE_TIME</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_HAL</span><span class="p">()</span>                                          <span class="c1"># Update pressure and flow measurement</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_PID_update</span><span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>                                <span class="c1"># With that, calculate controls</span>
            <span class="n">valve_open_in</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_control_signal_in</span><span class="p">()</span>           <span class="c1">#    -&gt; Inspiratory side: get control signal for PropValve</span>
            <span class="n">valve_open_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_control_signal_out</span><span class="p">()</span>          <span class="c1">#    -&gt; Expiratory side: get control signal for Solenoid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_HAL</span><span class="p">(</span><span class="n">valve_open_in</span><span class="p">,</span> <span class="n">valve_open_out</span><span class="p">)</span>             <span class="c1"># And set values.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span> <span class="o">=</span> <span class="n">now</span>

            <span class="k">if</span> <span class="n">update_copies</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_controls_from_COPY</span><span class="p">()</span>     <span class="c1"># Update controls from possibly updated values as a chunk</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>         <span class="c1"># Copy sensor values to COPY</span>
                <span class="n">update_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_copies</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span><span class="p">)</span>

        <span class="c1"># get final values on stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controls_from_COPY</span><span class="p">()</span>  <span class="c1"># Update controls from possibly updated values as a chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>  <span class="c1"># Copy sensor values to COPY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_valves_standby</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Balloon_Simulator"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.Balloon_Simulator">[docs]</a><span class="k">class</span> <span class="nc">Balloon_Simulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Physics simulator for inflating a balloon with an attached PEEP valve.</span>
<span class="sd">    For math, see https://en.wikipedia.org/wiki/Two-balloon_experiment</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peep_valve</span><span class="p">):</span>
        <span class="c1"># Hard parameters for the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_volume</span> <span class="o">=</span> <span class="mi">6</span>    <span class="c1"># Liters  - 6?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># Liters - baloon starts slightly inflated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PC</span> <span class="o">=</span> <span class="mi">50</span>           <span class="c1"># Proportionality constant that relates pressure to cm-H2O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P0</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># Baseline/Minimum pressure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leak</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fio2</span> <span class="o">=</span> <span class="mi">60</span>

        <span class="c1"># Dynamical parameters - these are the initial conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_flow</span>     <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># in unit  liters/sec</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qin</span>          <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># set flow of a prop valve on inspiratory side      -- liters/second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qin</span>              <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># exact flow of a prop valve on inspiratory side    -- liters/second</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qout</span>         <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0|max - setting of an solenoid on expiratory side -- liters/second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span>             <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># exact flow through the solenoid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># in unit  cm-H2O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># size of the lung</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span>                         <span class="c1"># in unit  liters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peep_valve</span> <span class="o">=</span> <span class="n">peep_valve</span>

<div class="viewcode-block" id="Balloon_Simulator.get_pressure"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.Balloon_Simulator.get_pressure">[docs]</a>    <span class="k">def</span> <span class="nf">get_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span></div>

<div class="viewcode-block" id="Balloon_Simulator.get_volume"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.Balloon_Simulator.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span></div>

<div class="viewcode-block" id="Balloon_Simulator.set_flow_in"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.Balloon_Simulator.set_flow_in">[docs]</a>    <span class="k">def</span> <span class="nf">set_flow_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Qin</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qin</span> <span class="o">=</span> <span class="n">Qin</span>

        <span class="n">Qin_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">Qin</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>                <span class="c1"># Flows have to be positive, and reasonable. Nothing here is faster that 2 l/s</span>
        <span class="n">Qin_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">Qin_clip</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qin</span>     <span class="o">=</span> <span class="n">Qin_clip</span>                    <span class="c1"># Assume the set-value is also the true value for prop</span></div>

<div class="viewcode-block" id="Balloon_Simulator.set_flow_out"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.Balloon_Simulator.set_flow_out">[docs]</a>    <span class="k">def</span> <span class="nf">set_flow_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Qout</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qout</span> <span class="o">=</span> <span class="n">Qout</span>

        <span class="n">Qout_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">Qout</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>                    <span class="c1"># Flows have to be positive, and reasonable. Nothing here is faster that 2 l/s</span>
        <span class="n">Qout_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">Qout_clip</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">difference_pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">-</span> <span class="mi">0</span>  <span class="c1"># Convention: outside is &quot;0&quot;</span>
        <span class="n">conductance</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">Qout_clip</span>                     <span class="c1"># This should be in the range of ~1 liter/s for typical max pressure differences</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">peep_valve</span><span class="p">:</span>      <span class="c1"># Action of the PEEP valve</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span> <span class="o">=</span> <span class="n">difference_pressure</span> <span class="o">*</span> <span class="n">conductance</span>    <span class="c1"># Target for flow out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Balloon_Simulator.update"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.Balloon_Simulator.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>  <span class="c1"># Performs an update of duration dt [seconds]</span>

        <span class="k">if</span> <span class="n">dt</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>                                         <span class="c1"># This is the simulation, so not quite so important, but no update should take longer than that</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qin</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span>     <span class="c1"># Flow into the balloon is the difference between flow-in and flow-out of the system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_flow</span> <span class="o">*</span> <span class="n">dt</span>

            <span class="c1"># This is from the baloon equation, uses helper variable (the baloon radius)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">r0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

            <span class="n">new_pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P0</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span> <span class="o">/</span> <span class="p">(</span><span class="n">r0</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">=</span> <span class="n">new_pressure</span>

            <span class="c1"># o2 fluctuations modelled as OUprocess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fio2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUupdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fio2</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span><span class="p">)</span></div>


<div class="viewcode-block" id="Balloon_Simulator.OUupdate"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.Balloon_Simulator.OUupdate">[docs]</a>    <span class="k">def</span> <span class="nf">OUupdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a simple function to produce an OU process on `variable`.</span>
<span class="sd">        It is used as model for fluctuations in measurement variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            variable (float): value of a variable at previous time step</span>
<span class="sd">            dt (float): timestep</span>
<span class="sd">            mu (float)): mean</span>
<span class="sd">            sigma (float): noise amplitude</span>
<span class="sd">            tau (float): time scale</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: value of &quot;variable&quot; at next time step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># Make sure this doesn&#39;t go haywire if anything hangs. Max 50ms</span>
        <span class="n">sigma_bis</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">sqrtdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">new_variable</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">variable</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma_bis</span> <span class="o">*</span> <span class="n">sqrtdt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_variable</span></div>

<div class="viewcode-block" id="Balloon_Simulator._reset"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.Balloon_Simulator._reset">[docs]</a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets Balloon to default settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qin</span>          <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qin</span>              <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qout</span>         <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span>             <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span></div></div>

<div class="viewcode-block" id="ControlModuleSimulator"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleSimulator">[docs]</a><span class="k">class</span> <span class="nc">ControlModuleSimulator</span><span class="p">(</span><span class="n">ControlModuleBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controlling Simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Implement ControlModuleBase functions</span>
<div class="viewcode-block" id="ControlModuleSimulator.__init__"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleSimulator.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulator_dt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">peep_valve_setting</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the ControlModuleBase with the simple simulation (for testing/dev).</span>

<span class="sd">        Args:</span>
<span class="sd">            simulator_dt (float, optional): timestep between updates. Defaults to None.</span>
<span class="sd">            peep_valve_setting (int, optional): Simulates action of a PEEP valve. Pressure cannot fall below. Defaults to 5.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ControlModuleBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_logs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span> <span class="o">=</span> <span class="n">Balloon_Simulator</span><span class="p">(</span><span class="n">peep_valve</span> <span class="o">=</span> <span class="n">peep_valve_setting</span><span class="p">)</span>          <span class="c1"># This is the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">get_pref</span><span class="p">(</span><span class="s1">&#39;CONTROLLER_LOOP_UPDATE_TIME_SIMULATOR&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simulator_dt</span> <span class="o">=</span> <span class="n">simulator_dt</span></div>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ControlModuleBase</span><span class="o">.</span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__SimulatedPropValve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This simulates the action of a proportional valve.</span>
<span class="sd">        Flow-current-curve eye-balled from generic prop vale with logistic activation.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (float): A control variable [like pulse-width-duty cycle or mA]</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: flow through the valve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flow_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mf">0.12</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">30</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">flow_new</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">flow_new</span>

    <span class="k">def</span> <span class="nf">__SimulatedSolenoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This simulates the action of a two-state Solenoid valve.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (float): If x==0: valve closed; x&gt;0: flow set to &quot;1&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: current flow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.</span>

<div class="viewcode-block" id="ControlModuleSimulator._sensor_to_COPY"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleSimulator._sensor_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_sensor_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the sensor value object from current (simulated) measurements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_sensor_values</span> <span class="o">=</span> <span class="n">SensorValues</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="p">{</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">FIO2</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">fio2</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">PRESSURE</span><span class="o">.</span><span class="n">name</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">current_pressure</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">VTE</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="o">.</span><span class="n">name</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span><span class="p">,</span>
              <span class="n">ValueName</span><span class="o">.</span><span class="n">FLOWOUT</span><span class="o">.</span><span class="n">name</span>              <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span><span class="p">,</span>
              <span class="s1">&#39;timestamp&#39;</span>                         <span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
              <span class="s1">&#39;loop_counter&#39;</span>                      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span><span class="p">,</span>
              <span class="s1">&#39;breath_count&#39;</span>                      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span>
            <span class="p">})</span></div>

<div class="viewcode-block" id="ControlModuleSimulator._start_mainloop"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.ControlModuleSimulator._start_mainloop">[docs]</a>    <span class="k">def</span> <span class="nf">_start_mainloop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the main loop. This method should be run as a thread (see the `start()` method in `ControlModuleBase`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">update_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MainLoop: start&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator_dt</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator_dt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span>                            <span class="c1"># Time sincle last cycle of main-loop</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>                                            <span class="c1"># TODO: RAISE HARDWARE ALARM, no update should take longer than 0.5 sec</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MainLoop: Update too long: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restarted cycle.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_control_reset</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>                            <span class="c1"># Update the state of the balloon simulation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">get_pressure</span><span class="p">())</span> <span class="c1"># Get a pressure measurement from balloon and tell controller</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_PID_update</span><span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>                               <span class="c1"># Update the PID Controller</span>

            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_control_signal_in</span><span class="p">()</span>                       <span class="c1"># Inspiratory side: get control signal for PropValve</span>
            <span class="n">Qin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SimulatedPropValve</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                      <span class="c1"># And calculate the produced flow Qin</span>

            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_control_signal_out</span><span class="p">()</span>                      <span class="c1"># Expiratory side: get control signal for Solenoid</span>
            <span class="n">Qout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SimulatedSolenoid</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>                      <span class="c1"># Set expiratory flow rate, Qout</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">set_flow_in</span><span class="p">(</span><span class="n">Qin</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>                  <span class="c1"># Set the flow rates for the Balloon simulator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">set_flow_out</span><span class="p">(</span><span class="n">Qout</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">Qout</span>                     <span class="c1"># Tell controller the expiratory flow rate, _DATA_Qout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span> <span class="o">=</span> <span class="n">now</span>

            <span class="k">if</span> <span class="n">update_copies</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_controls_from_COPY</span><span class="p">()</span>     <span class="c1"># Update controls from possibly updated values as a chunk</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>         <span class="c1"># Copy sensor values to COPY</span>
                <span class="n">update_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_copies</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span><span class="p">)</span>

        <span class="c1"># get final values on stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controls_from_COPY</span><span class="p">()</span>  <span class="c1"># Update controls from possibly updated values as a chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>  <span class="c1"># Copy sensor values to COPY</span></div></div>




<div class="viewcode-block" id="get_control_module"><a class="viewcode-back" href="../../../pvp.controller.html#pvp.controller.control_module.get_control_module">[docs]</a><span class="k">def</span> <span class="nf">get_control_module</span><span class="p">(</span><span class="n">sim_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simulator_dt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates control module.</span>

<span class="sd">    Args:</span>
<span class="sd">        sim_mode (bool, optional): if ``true``: returns simulation, else returns hardware. Defaults to False.</span>
<span class="sd">        simulator_dt (float, optional): a timescale for thee simulation. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ControlModule-Object: Either configured for simulation, or physical device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sim_mode</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ControlModuleSimulator</span><span class="p">(</span><span class="n">simulator_dt</span> <span class="o">=</span> <span class="n">simulator_dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ControlModuleDevice</span><span class="p">(</span><span class="n">save_logs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">flush_every</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">config_file</span> <span class="o">=</span> <span class="s1">&#39;pvp/io/config/devices.ini&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, jonny saunders et al

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>