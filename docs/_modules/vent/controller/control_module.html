

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>vent.controller.control_module &mdash; PVP 0.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/pvp_theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pvp_theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../../index.html" class="icon icon-home"> PVP
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../control_overview.html">Control Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Hardware:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware.html">Hardware Placeholder</a></li>
</ul>
<p class="caption"><span class="caption-text">Software:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../common.html">common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../controller.html">controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coordinator.html">coordinator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gui.html">GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io.html">io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../alarm.html">alarm</a></li>
</ul>
<p class="caption"><span class="caption-text">Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../requirements.html">Ventilator Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasheets.html">Datasheets &amp; Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../specs.html">Specifications</a></li>
</ul>
<p class="caption"><span class="caption-text">Meta:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog/index.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../buildthedocs.html">Building the Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example_markdown.html">Markdown Example</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PVP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>vent.controller.control_module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for vent.controller.control_module</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>

<span class="kn">import</span> <span class="nn">vent.io</span> <span class="k">as</span> <span class="nn">io</span>

<span class="kn">from</span> <span class="nn">vent.common.message</span> <span class="kn">import</span> <span class="n">SensorValues</span><span class="p">,</span> <span class="n">ControlValues</span><span class="p">,</span> <span class="n">ControlSetting</span>
<span class="kn">from</span> <span class="nn">vent.common.logging</span> <span class="kn">import</span> <span class="n">init_logger</span><span class="p">,</span> <span class="n">DataLogger</span>
<span class="kn">from</span> <span class="nn">vent.common.values</span> <span class="kn">import</span> <span class="n">CONTROL</span><span class="p">,</span> <span class="n">ValueName</span>
<span class="kn">from</span> <span class="nn">vent.alarm</span> <span class="kn">import</span> <span class="n">AlarmSeverity</span><span class="p">,</span> <span class="n">Alarm</span>


<div class="viewcode-block" id="ControlModuleBase"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase">[docs]</a><span class="k">class</span> <span class="nc">ControlModuleBase</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This is an abstract class for controlling simulation and hardware.</span>

<span class="sd">    1. All internal variables fall in three classes, denoted by the beginning of the variable:</span>
<span class="sd">        - &quot;COPY_varname&quot;: These are copies (see 1.) that are regularly sync&#39;ed with internal variables.</span>
<span class="sd">        - &quot;__varname&quot;:    These are variables only used in the ControlModuleBase-Class</span>
<span class="sd">        - &quot;_varname&quot;:     These are variables used in derived classes.</span>

<span class="sd">    2. Internal variables should only to be accessed though the set_ and get_ functions.</span>
<span class="sd">        These functions act on COPIES of internal variables (&quot;__&quot; and &quot;_&quot;), that are sync&#39;d every few</span>
<span class="sd">        iterations. How often this is done is adjusted by the variable</span>
<span class="sd">        self._NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE. To avoid multiple threads manipulating the same </span>
<span class="sd">        variables at the same time, every manipulation of &quot;COPY_&quot; is surrounded by a thread lock.</span>

<span class="sd">    Public Methods:</span>
<span class="sd">        get_sensors():                     Returns a copy of the current sensor values.</span>
<span class="sd">        get_alarms():                      Returns a List of all alarms, active and logged</span>
<span class="sd">        get_active_alarms():               Returns a Dictionary of all currently active alarms.</span>
<span class="sd">        get_logged_alarms():               Returns a List of logged alarms, up to maximum lengh of self._RINGBUFFER_SIZE</span>
<span class="sd">        get_control(ControlSetting):       Sets a controll-setting. Is updated at latest within self._NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>
<span class="sd">        get_past_waveforms():              Returns a List of waveforms of pressure and volume during at the last N breath cycles, N&lt;self._RINGBUFFER_SIZE, AND clears this archive.</span>
<span class="sd">        get_target_waveform():             Returns a step-wise linear target waveform, as defined by the current settings.</span>
<span class="sd">        start():                           Starts the main-loop of the controller</span>
<span class="sd">        stop():                            Stops the main-loop of the controller</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ControlModuleBase.__init__"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_logs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">flush_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            save_logs (bool): whether sensor data and controls should be saved with the :class:`.DataLogger`</span>
<span class="sd">            flush_every (int): flush and rotate logs every n breath cycles</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">init_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;controller init&#39;</span><span class="p">)</span>

        <span class="c1">#####################  Algorithm/Program parameters  ##################</span>
        <span class="c1"># Hyper-Parameters</span>
        <span class="c1"># TODO: These should probably all (or whichever make sense) should be args to __init__ -jls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span>                   <span class="o">=</span> <span class="mf">0.01</span>    <span class="c1"># Run the main control loop every 0.01 sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span> <span class="o">=</span> <span class="mi">10</span>      <span class="c1"># After every 10 main control loop iterations, update COPYs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_RINGBUFFER_SIZE</span>                    <span class="o">=</span> <span class="mi">100</span>     <span class="c1"># Maximum number of breath cycles kept in memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span>                          <span class="o">=</span> <span class="n">save_logs</span>   <span class="c1"># Keep logs in a file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FLUSH_EVERY</span>                        <span class="o">=</span> <span class="n">flush_every</span>

        <span class="c1">#########################  Control management  #########################</span>

        <span class="c1"># This is what the machine has controll over:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span>  <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># State of a valve on the inspiratory side - could be a proportional valve.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># State of a valve on the exspiratory side - this is open/close i.e. value in (0,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span>    <span class="o">=</span> <span class="kc">True</span>           <span class="c1"># Default is: use PID control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__KP</span>                 <span class="o">=</span> <span class="mi">80</span>             <span class="c1"># The weights for the the PID terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__KI</span>                 <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__KD</span>                 <span class="o">=</span> <span class="mi">0</span>


        <span class="c1"># Internal Control variables. &quot;SET&quot; indicates that this is set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span>       <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>                     <span class="c1"># Target PIP pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_TIME</span>  <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>                <span class="c1"># Target time to reach PIP in seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span>      <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>                    <span class="c1"># Target PEEP pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span> <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>               <span class="c1"># Target time to reach PEEP from PIP plateau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>       <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>      <span class="c1"># Target breaths per minute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>   <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>    <span class="c1"># Target duration of inspiratory phase</span>

        <span class="c1"># Derived internal control variables - fully defined by numbers above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_E_PHASE</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_T_PLATEAU</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_TIME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_T_PEEP</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_E_PHASE</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span>

        <span class="c1"># Alarm management; controller can only react to High airway pressure alarms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#########################  Data management  #########################</span>

        <span class="c1"># These are measurements from the last breath cycle.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># Measured value of PIP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Measured pressure of the plateau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_TIME</span> <span class="o">=</span> <span class="kc">None</span>    <span class="c1"># Measured time of reaching PIP plateau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span> <span class="o">=</span> <span class="kc">None</span>        <span class="c1"># Measured valued of PEEP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># Measured duration of inspiratory phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_LAST_PEEP</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Last time of PEEP - by definition end of breath cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># Measured breathing rate, by definition 60sec / length_of_breath_cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># Maximum air displacement in last breath cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_P</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># Last measurements of the proportional term for PID-control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># Last measurements of the integral term for PID-control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_D</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1"># Last measurements of the differential term for PID-control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># Total number of breaths/id of current breath cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_breath_counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span> <span class="c1"># threadsafe counter</span>

        <span class="c1"># Parameters to keep track of breath-cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>                            <span class="c1"># To build up the current cycle&#39;s waveform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RINGBUFFER_SIZE</span><span class="p">)</span>          <span class="c1"># An archive of past waveforms.</span>

        <span class="c1"># These are measurements that change from timepoint to timepoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_VOLUME</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qin</span>      <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># Measurement of the airflow in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span>     <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># Measurement of the airflow out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_dpdt</span>     <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># Current sample of the rate of change of pressure dP/dt in cmH2O/sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span>   <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


        <span class="c1">#########################  Alarm management  #########################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__active_alarms</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># Dictionary of active alarms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logged_alarms</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RINGBUFFER_SIZE</span><span class="p">)</span>     <span class="c1"># List of all resolved alarms</span>

        <span class="c1"># Variable limits to raise alarms, initialized as small deviation of what the controller initializes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_min</span>          <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_max</span>          <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_lastset</span>      <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_min</span>     <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_max</span>     <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_lastset</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_min</span>         <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_max</span>         <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_lastset</span>     <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_min</span>    <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_max</span>    <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP_TIME</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_lastset</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_min</span>          <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_max</span>          <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_lastset</span>      <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_min</span>      <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_max</span>      <span class="o">=</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">]</span><span class="o">.</span><span class="n">safe_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_lastset</span>  <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1">############### Initialize COPY variables for threads  ##############</span>
        <span class="c1"># COPY variables that later updated on a regular basis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_active_alarms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_logged_alarms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__logged_alarms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_sensor_values</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># empty SensorValues can no longer be instantiated -jls</span>

        <span class="c1">###########################  Threading init  #########################</span>
        <span class="c1"># Run the start() method as a thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alarm_to_COPY</span><span class="p">()</span>  <span class="c1">#These require the lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_set_to_COPY</span><span class="p">()</span>

        <span class="c1"># self.__thread = threading.Thread(target=self._start_mainloop, daemon=True)</span>
        <span class="c1"># self.__thread.start()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">############################# Logging ################################</span>
        <span class="c1"># Create an instance of the DataLogger class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dl</span> <span class="o">=</span> <span class="n">DataLogger</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># raised if not enough space</span>
                <span class="c1"># TODO: Log this</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;couldnt start data logger, not saving logs&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">close_logfile</span><span class="p">()</span>

<div class="viewcode-block" id="ControlModuleBase._initialize_set_to_COPY"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._initialize_set_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_initialize_set_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="c1"># Copy of the SET variables for threading.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP_TIME</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_TIME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP_TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_BPM</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase._alarm_to_COPY"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._alarm_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_alarm_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="c1"># Update the alarms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_active_alarms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__active_alarms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_logged_alarms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__logged_alarms</span><span class="p">)</span>

        <span class="c1"># The alarm thresholds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_lastset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_lastset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_min</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_lastset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_lastset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_lastset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_lastset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_lastset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_lastset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_min</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_lastset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_lastset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_lastset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_lastset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase._sensor_to_COPY"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._sensor_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_sensor_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># These variables have to come from the hardware</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="c1"># Make sure you have acquire and release!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ControlModuleBase._controls_from_COPY"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._controls_from_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_controls_from_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Update SET variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="c1">#Update values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_TIME</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP_TIME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP_TIME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_BPM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span>

        <span class="c1">#Update derived values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_BPM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_E_PHASE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_T_PLATEAU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_TIME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SET_T_PEEP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_E_PHASE</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span>

        <span class="c1">#Update new confidence intervals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_min</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_max</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_max</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_lastset</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_lastset</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_min</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_min</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_max</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_max</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_lastset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_lastset</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_min</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_min</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_max</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_max</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_lastset</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_lastset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_min</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_max</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_time_lastset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_lastset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_min</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_min</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_max</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_max</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">__bpm_lastset</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_lastset</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_min</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_min</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_max</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_max</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_lastset</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_lastset</span>  

        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__test_critical_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This tests whether a variable is within bounds.</span>
<span class="sd">        If it is, and an alarm existed, then the &quot;alarm_end_time&quot; is set.</span>
<span class="sd">        If it is NOT, a new alarm is generated and appendede to the alarm-list.</span>
<span class="sd">        Input:</span>
<span class="sd">            min:           minimum value  (e.g. 2)</span>
<span class="sd">            max:           maximum value  (e.g. 5)</span>
<span class="sd">            value:         test value   (e.g. 3)</span>
<span class="sd">            name:          parameter type (e.g. &quot;PIP&quot;, &quot;PEEP&quot; etc.)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>
        <span class="c1"># if (value &lt; min) or (value &gt; max):  # If the variable is not within limits</span>
        <span class="c1">#     if name not in self.__active_alarms.keys():  # And and alarm for that variable doesn&#39;t exist yet -&gt; RAISE ALARM.</span>
        <span class="c1">#         new_alarm = Alarm(alarm_name=name, active=True, severity=AlarmSeverity.HIGH, value=value,</span>
        <span class="c1">#                           start_time=time.time(), alarm_end_time=None)</span>
        <span class="c1">#         self.__active_alarms[name] = new_alarm</span>
        <span class="c1"># else:  # Else: if the variable is within bounds,</span>
        <span class="c1">#     if name in self.__active_alarms.keys():  # And an alarm exists -&gt; inactivate it.</span>
        <span class="c1">#         old_alarm = self.__active_alarms[name]</span>
        <span class="c1">#         old_alarm.alarm_end_time = time.time()</span>
        <span class="c1">#         old_alarm.active = False</span>
        <span class="c1">#         self.__logged_alarms.append(old_alarm)</span>
        <span class="c1">#         del self.__active_alarms[name]</span>

    <span class="k">def</span> <span class="nf">__analyze_last_waveform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; This goes through the last waveform, and updates VTE, PEEP, PIP, PIP_TIME, I_PHASE, FIRST_PEEP and BPM.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Only if there was a previous cycle</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pressure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">mean_pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>

            <span class="c1"># get the pressure niveau heuristically (much faster than fitting)</span>
            <span class="c1"># 20/80 percentile of pressure values below/above mean</span>
            <span class="c1"># Assumption: waveform is mostly between both plateaus</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mean_pressure</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span> <span class="n">pressure</span> <span class="o">&lt;</span> <span class="n">mean_pressure</span><span class="p">],</span> <span class="mi">20</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span> <span class="n">pressure</span> <span class="o">&gt;</span> <span class="n">mean_pressure</span><span class="p">],</span> <span class="mi">80</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pressure</span><span class="p">[</span> <span class="n">pressure</span> <span class="o">&gt;</span> <span class="n">mean_pressure</span><span class="p">],</span> <span class="mi">95</span> <span class="p">)</span>             <span class="c1">#PIP is defined as the maximum, here 95% to account for outliers</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_TIME</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span><span class="o">*</span><span class="mf">0.9</span><span class="p">))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span><span class="o">*</span><span class="mf">0.9</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_PLATEAU</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_TIME</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># and measure the breaths per minute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span> <span class="o">=</span> <span class="mf">60.</span> <span class="o">/</span> <span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 60 sec divided by the duration of last waveform</span>

    <span class="k">def</span> <span class="nf">__update_alarms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; This goes through the values obtained from the last waveform, and updates alarms.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span> <span class="c1"># Only if there was a previous cycle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__test_critical_levels</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__PIP_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__PIP_max</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__test_critical_levels</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__PIP_time_max</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP_TIME</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__test_critical_levels</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__PEEP_max</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__test_critical_levels</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__bpm_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__bpm_max</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__test_critical_levels</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__I_phase_max</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">)</span>

<div class="viewcode-block" id="ControlModuleBase.get_sensors"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.get_sensors">[docs]</a>    <span class="k">def</span> <span class="nf">get_sensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SensorValues</span><span class="p">:</span>
        <span class="c1"># Make sure to return a copy of the instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="c1">#cp = copy.deepcopy( self.COPY_sensor_values )</span>
        <span class="c1"># don&#39;t need to deepcopy because a new SensorValues object is created</span>
        <span class="c1"># each time and it copies each individual value as it&#39;s created</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COPY_sensor_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cp</span></div>

    <span class="c1"># def get_alarms(self) -&gt; List[Alarm]:</span>
    <span class="c1">#     # Returns all alarms as a list</span>
    <span class="c1">#     self._lock.acquire()</span>
    <span class="c1">#     new_alarm_list = self.COPY_logged_alarms.copy()</span>
    <span class="c1">#     for alarm_key in self.COPY_active_alarms.keys():</span>
    <span class="c1">#         new_alarm_list.append(self.COPY_active_alarms[alarm_key])</span>
    <span class="c1">#     self._lock.release()</span>
    <span class="c1">#     return new_alarm_list</span>

<div class="viewcode-block" id="ControlModuleBase.get_active_alarms"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.get_active_alarms">[docs]</a>    <span class="k">def</span> <span class="nf">get_active_alarms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Returns only the active alarms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">active_alarms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_active_alarms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Make sure to return a copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">active_alarms</span></div>

<div class="viewcode-block" id="ControlModuleBase.get_logged_alarms"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.get_logged_alarms">[docs]</a>    <span class="k">def</span> <span class="nf">get_logged_alarms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Alarm</span><span class="p">]:</span>
        <span class="c1"># Returns only the inactive alarms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">logged_alarms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COPY_logged_alarms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">logged_alarms</span></div>



<div class="viewcode-block" id="ControlModuleBase.set_control"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.set_control">[docs]</a>    <span class="k">def</span> <span class="nf">set_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_setting</span><span class="p">:</span> <span class="n">ControlSetting</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Updates the entry of COPY contained in the control settings&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_min</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">min_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_max</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_lastset</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">timestamp</span>

        <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP_TIME</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_min</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">min_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_max</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_lastset</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">timestamp</span>

        <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_min</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">min_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_max</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_lastset</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">timestamp</span>

        <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_BPM</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_min</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">min_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_max</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_lastset</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">timestamp</span>

        <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_min</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">min_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_max</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_lastset</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">timestamp</span>

        <span class="k">elif</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP_TIME</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP_TIME</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_min</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">min_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_max</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">max_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_lastset</span> <span class="o">=</span> <span class="n">control_setting</span><span class="o">.</span><span class="n">timestamp</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;You cannot set the variabe: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_setting</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">store_control_command</span><span class="p">(</span><span class="n">control_setting</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase.get_control"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.get_control">[docs]</a>    <span class="k">def</span> <span class="nf">get_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_setting_name</span><span class="p">:</span> <span class="n">ValueName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ControlSetting</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39; Gets values of the COPY of the control settings. &#39;&#39;&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_min</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_max</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_lastset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP_TIME</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PIP_TIME</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_min</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_max</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PIP_time_lastset</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_min</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_max</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_lastset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_BPM</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_min</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_max</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_bpm_lastset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_I_PHASE</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_min</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_max</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">COPY_I_phase_lastset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">control_setting_name</span> <span class="o">==</span> <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP_TIME</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">ControlSetting</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">COPY_SET_PEEP_TIME</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_min</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_max</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">COPY_PEEP_time_lastset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;You cannot set the variabe: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">control_setting_name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">return_value</span></div>

    <span class="k">def</span> <span class="nf">__get_PID_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ytarget</span><span class="p">,</span> <span class="n">yis</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">error_new</span> <span class="o">=</span> <span class="n">ytarget</span> <span class="o">-</span> <span class="n">yis</span>                   <span class="c1"># New value of the error</span>

        <span class="n">RC</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Time constant in seconds</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">+</span> <span class="n">RC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span> <span class="o">+</span> <span class="n">s</span><span class="o">*</span><span class="p">(</span><span class="n">error_new</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span><span class="p">)</span>     <span class="c1"># Integral term on some timescale RC  -- TODO: If used, for real system, add integral windup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_D</span> <span class="o">=</span> <span class="n">error_new</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_P</span> <span class="o">=</span> <span class="n">error_new</span>

    <span class="k">def</span> <span class="nf">__calculate_control_signal_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span>  <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># Some setting for the maximum flow.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">+=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__KP</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">+=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__KI</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">+=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__KD</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_D</span>

<div class="viewcode-block" id="ControlModuleBase._get_control_signal_in"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._get_control_signal_in">[docs]</a>    <span class="k">def</span> <span class="nf">_get_control_signal_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; This is the PID controlled signal on the inspiratory side &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span></div>

<div class="viewcode-block" id="ControlModuleBase._get_control_signal_out"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._get_control_signal_out">[docs]</a>    <span class="k">def</span> <span class="nf">_get_control_signal_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; This is the control signal (open/close) on the expiratory side &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span></div>

<div class="viewcode-block" id="ControlModuleBase._PID_reset"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._PID_reset">[docs]</a>    <span class="k">def</span> <span class="nf">_PID_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; resets the PID cycle to zero&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase._PID_update"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._PID_update">[docs]</a>    <span class="k">def</span> <span class="nf">_PID_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">        This instantiates the control algorithms.</span>
<span class="sd">        During the breathing cycle, it goes through the four states:</span>
<span class="sd">           1) Rise to PIP</span>
<span class="sd">           2) Sustain PIP pressure</span>
<span class="sd">           3) Quick fall to PEEP</span>
<span class="sd">           4) Sustaint PEEP pressure</span>
<span class="sd">        Once the cycle is complete, it checks the cycle for any alarms, and starts a new one.</span>
<span class="sd">        A record of pressure/volume waveforms is kept in self.__cycle_waveform_archive</span>

<span class="sd">            dt: Time since last update in seconds </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cycle_phase</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_start</span>
        <span class="n">next_cycle</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_VOLUME</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qin</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="p">)</span>  <span class="c1"># Integrate what has happened within the last few seconds from the measurements of Qin and Qout</span>

        <span class="k">if</span> <span class="n">cycle_phase</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_TIME</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span><span class="p">:</span>
                <span class="n">target_pressure</span> <span class="o">=</span> <span class="n">cycle_phase</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_TIME</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__get_PID_error</span><span class="p">(</span><span class="n">yis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="n">ytarget</span> <span class="o">=</span> <span class="n">target_pressure</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_control_signal_in</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># close out valve</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>                                                        <span class="c1"># STATE CONTROL: to PIP, air in as fast as possible</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">elif</span> <span class="n">cycle_phase</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span><span class="p">:</span>                                                           <span class="c1"># then, we control PIP</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__get_PID_error</span><span class="p">(</span><span class="n">yis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="n">ytarget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_control_signal_in</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="o">+</span><span class="mf">0.5</span><span class="p">:</span>                                              
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">1</span>                                                        <span class="c1"># if exceeded, we open the exhaust valve</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>                                                        <span class="c1"># close out valve</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="mi">0</span>                                                             <span class="c1"># STATE CONTROL: keep PIP plateau, let air in if below</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">cycle_phase</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span><span class="p">:</span>                                     <span class="c1"># then, we drop pressure to PEEP</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span><span class="p">:</span>
                <span class="n">target_pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span> <span class="o">-</span> <span class="p">(</span><span class="n">cycle_phase</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__get_PID_error</span><span class="p">(</span><span class="n">yis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="n">ytarget</span> <span class="o">=</span> <span class="n">target_pressure</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_control_signal_in</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span>  <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">cycle_phase</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span><span class="p">:</span>                                                     <span class="c1"># and control around PEEP</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__get_PID_error</span><span class="p">(</span><span class="n">yis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="n">ytarget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_control_signal_in</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>                                                                                         <span class="c1"># STATE CONTROL: keeping PEEP, let air in if below</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># New cycle starts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_VOLUME</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># ... start at zero volume in the lung</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_dpdt</span>    <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># and restart the rolling average for the dP/dt estimation</span>
            <span class="n">next_cycle</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_high_pressure_alert</span><span class="p">():</span>   <span class="c1"># HAPA overwrites all other signals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span> <span class="o">=</span> <span class="mi">30</span>                <span class="c1"># Default: PIP to 30</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span>  <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">next_cycle</span><span class="p">:</span>                        <span class="c1"># if a new breath cycle has started</span>
            <span class="c1"># increment breath_cycle tracker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_breath_counter</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_VOLUME</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__analyze_last_waveform</span><span class="p">()</span>    <span class="c1"># Analyze last waveform</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update_alarms</span><span class="p">()</span>            <span class="c1"># Run alarm detection over last cycle&#39;s waveform</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>            <span class="c1"># Get the fit values from the last waveform directly into sensor values</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FLUSH_EVERY</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">flush_logfile</span><span class="p">()</span>        <span class="c1"># If we kept records, flush the data from the previous breath cycle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">rotation_newfile</span><span class="p">()</span>     <span class="c1"># And Check whether we run out of space for the logger</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform</span><span class="p">,</span> <span class="p">[[</span><span class="n">cycle_phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DATA_VOLUME</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__save_values</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase.check_high_pressure_alert"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.check_high_pressure_alert">[docs]</a>    <span class="k">def</span> <span class="nf">check_high_pressure_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The only alarm that has to be raised by the controller is High Airway Pressure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>                             <span class="c1"># TODO: WHAT IS THE LIMIT?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># 100 ms active to avoid being triggered by coughs</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAPA</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">__save_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Small helper function to store key parameters in the main PID control loop</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make the sensor value instance</span>
        <span class="n">sensor_values</span> <span class="o">=</span>  <span class="n">SensorValues</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="p">{</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">FIO2</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">PRESSURE</span><span class="o">.</span><span class="n">name</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">VTE</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="o">.</span><span class="n">name</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span><span class="p">,</span>
        <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span><span class="p">,</span>
        <span class="s1">&#39;timestamp&#39;</span>                         <span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
        <span class="s1">&#39;loop_counter&#39;</span>                      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span><span class="p">,</span>
        <span class="s1">&#39;breath_count&#39;</span>                      <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span>
        <span class="p">})</span>

        <span class="c1">#And the control value instance</span>
        <span class="n">control_values</span> <span class="o">=</span> <span class="n">ControlValues</span><span class="p">(</span>
            <span class="n">control_signal_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_in</span><span class="p">,</span>
            <span class="n">control_signal_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__control_signal_out</span><span class="p">,</span>
            <span class="n">flow_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qin</span><span class="p">,</span>
            <span class="n">flow_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span>
        <span class="p">)</span>

        <span class="c1">#And save both</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">store_waveform_data</span><span class="p">(</span><span class="n">sensor_values</span><span class="p">,</span> <span class="n">control_values</span><span class="p">)</span>

<div class="viewcode-block" id="ControlModuleBase.get_past_waveforms"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.get_past_waveforms">[docs]</a>    <span class="k">def</span> <span class="nf">get_past_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Returns a list of past waveforms.</span>
        <span class="c1"># Format:</span>
        <span class="c1">#     Returns a list of [Nx3] waveforms, of [time, pressure, volume]</span>
        <span class="c1">#     Most recent entry is waveform_list[-1]</span>
        <span class="c1"># Note:</span>
        <span class="c1">#     After calling this function, archive is emptied!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span> <span class="p">)</span> <span class="c1"># Make sure to return a copy as a list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RINGBUFFER_SIZE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cycle_waveform_archive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">archive</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">archive</span></div>

<div class="viewcode-block" id="ControlModuleBase.get_target_waveform"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.get_target_waveform">[docs]</a>    <span class="k">def</span> <span class="nf">get_target_waveform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Returns the target waveform, drawn as a sketch of a stepwise linear function</span>
        <span class="c1"># Format is time-points, pressure values - to be connected with straight lines</span>
        <span class="c1">#         ______</span>
        <span class="c1">#        /      \                         &lt;- Sketch waveform of single breath cycle</span>
        <span class="c1">#       /        \</span>
        <span class="c1">#      /          \____________</span>
        <span class="c1">#</span>
        <span class="c1">#     ^  ^     ^  ^           ^</span>
        <span class="c1">#     A  B     C  D           E           &lt;- Critical time points</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">wv</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">),</span>                                            <span class="c1"># A: start of the waveform</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP_TIME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="p">),</span>                           <span class="c1"># B: reaching PIP within PIP_TIME</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PIP</span><span class="p">),</span>                            <span class="c1"># C: keeping the plateau during I_Phase</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP_TIME</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_I_PHASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">),</span>    <span class="c1"># D: reaching PEEP within PEEP TIME</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SET_CYCLE_DURATION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SET_PEEP</span><span class="p">))</span>                    <span class="c1"># E: Cycle ends</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">wv</span></div>

<div class="viewcode-block" id="ControlModuleBase._start_mainloop"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase._start_mainloop">[docs]</a>    <span class="k">def</span> <span class="nf">_start_mainloop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This will depend on simulation or reality</span>
        <span class="k">pass</span>   </div>

<div class="viewcode-block" id="ControlModuleBase.start"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>  <span class="c1"># If the previous thread has been stopped, make a new one.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_mainloop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main Loop already running.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ControlModuleBase.stop"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main Loop is not running.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_logs</span><span class="p">:</span>               <span class="c1"># If we kept records, flush the data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dl</span><span class="o">.</span><span class="n">close_logfile</span><span class="p">()</span></div>


<div class="viewcode-block" id="ControlModuleBase.is_running"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.is_running">[docs]</a>    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: this should be better thread-safe variable</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleBase.do_pid_control"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.do_pid_control">[docs]</a>    <span class="k">def</span> <span class="nf">do_pid_control</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Already running PID control.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ControlModuleBase.do_state_control"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleBase.do_state_control">[docs]</a>    <span class="k">def</span> <span class="nf">do_state_control</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Already running State control.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid_control_flag</span> <span class="o">=</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="ControlModuleDevice"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleDevice">[docs]</a><span class="k">class</span> <span class="nc">ControlModuleDevice</span><span class="p">(</span><span class="n">ControlModuleBase</span><span class="p">):</span>
    <span class="c1"># Implement ControlModuleBase functions</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ControlModuleBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Hal</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="s1">&#39;vent/io/config/dinky-devices.ini&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>
        
<div class="viewcode-block" id="ControlModuleDevice._sensor_to_COPY"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleDevice._sensor_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_sensor_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># And the sensor measurements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_sensor_values</span> <span class="o">=</span> <span class="n">SensorValues</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="p">{</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">FIO2</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">PRESSURE</span><span class="o">.</span><span class="n">name</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">VTE</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="o">.</span><span class="n">name</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span>                  <span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="s1">&#39;loop_counter&#39;</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span><span class="p">,</span>
            <span class="s1">&#39;breath_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleDevice._start_mainloop"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleDevice._start_mainloop">[docs]</a>    <span class="k">def</span> <span class="nf">_start_mainloop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># start running, this should be run as a thread! </span>
        <span class="c1"># Compare to initialization in Base Class!</span>

        <span class="n">update_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span>                            <span class="c1"># Time sincle last cycle of main-loop</span>

            <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">CONTROL</span><span class="p">[</span><span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="o">/</span> <span class="mi">4</span><span class="p">:</span>                                                      <span class="c1"># TODO: RAISE HARDWARE ALARM, no update should be so long</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restarted cycle.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_PID_reset</span><span class="p">()</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">pressure</span>                 <span class="c1"># Get a pressure measurement from HAL</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_PID_update</span><span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>                               <span class="c1"># Update the PID Controller</span>

            <span class="n">valve_open_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_control_signal_in</span><span class="p">()</span>           <span class="c1"># Inspiratory side: get control signal for PropValve</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">setpoint_in</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">valve_open_in</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">setpoint_ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_control_signal_out</span><span class="p">()</span>          <span class="c1"># Expiratory side: get control signal for Solenoid</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            if(self.HAL.setpoint_ex == 0):</span>
<span class="sd">                self.HAL._expiratory_valve.close()</span>
<span class="sd">            else:</span>
<span class="sd">                self.HAL._expiratory_valve.open()</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">flow_ex</span>                     <span class="c1"># Flow sensor on Expiratory side</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qin</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAL</span><span class="o">.</span><span class="n">flow_in</span>                      <span class="c1"># Flow sensor on inspiratory side. NOTE: used to calculate VTE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span> <span class="o">=</span> <span class="n">now</span>

            <span class="k">if</span> <span class="n">update_copies</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_controls_from_COPY</span><span class="p">()</span>     <span class="c1"># Update controls from possibly updated values as a chunk</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_alarm_to_COPY</span><span class="p">()</span>          <span class="c1"># Copy current alarms and settings to COPY</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>         <span class="c1"># Copy sensor values to COPY</span>
                <span class="n">update_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_copies</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># # get final values on stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controls_from_COPY</span><span class="p">()</span>  <span class="c1"># Update controls from possibly updated values as a chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alarm_to_COPY</span><span class="p">()</span>  <span class="c1"># Copy current alarms and settings to COPY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>  <span class="c1"># Copy sensor values to COPY</span></div></div>



<div class="viewcode-block" id="Balloon_Simulator"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.Balloon_Simulator">[docs]</a><span class="k">class</span> <span class="nc">Balloon_Simulator</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is a imple physics simulator for inflating a balloon. </span>
<span class="sd">    For math, see https://en.wikipedia.org/wiki/Two-balloon_experiment</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leak</span><span class="p">):</span>
        <span class="c1"># Hard parameters for the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_volume</span> <span class="o">=</span> <span class="mi">6</span>    <span class="c1"># Liters  - 6?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># Liters - baloon starts slightly inflated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PC</span> <span class="o">=</span> <span class="mi">40</span>           <span class="c1"># Proportionality constant that relates pressure to cm-H2O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P0</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># Baseline/Minimum pressure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="mi">37</span>  <span class="c1"># keep track of these, as they are important output variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">humidity</span> <span class="o">=</span> <span class="mi">90</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fio2</span> <span class="o">=</span> <span class="mi">60</span>

        <span class="c1"># Dynamical parameters - these are the initial conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_flow</span>     <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># in unit  liters/sec</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qin</span>          <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># set flow of a prop valve on inspiratory side      -- liters/second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qin</span>              <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># exact flow of a prop valve on inspiratory side    -- liters/second</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qout</span>         <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0|max - setting of an solenoid on expiratory side -- liters/second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span>             <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># exact flow through the solenoid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># in unit  cm-H2O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># size of the lung</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span>                         <span class="c1"># in unit  liters</span>

<div class="viewcode-block" id="Balloon_Simulator.get_pressure"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.Balloon_Simulator.get_pressure">[docs]</a>    <span class="k">def</span> <span class="nf">get_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span></div>

<div class="viewcode-block" id="Balloon_Simulator.get_volume"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.Balloon_Simulator.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span></div>

<div class="viewcode-block" id="Balloon_Simulator.set_flow_in"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.Balloon_Simulator.set_flow_in">[docs]</a>    <span class="k">def</span> <span class="nf">set_flow_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Qin</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qin</span> <span class="o">=</span> <span class="n">Qin</span>

        <span class="n">Qin_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">Qin</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>                <span class="c1"># Flows have to be positive, and reasonable. Nothing here is faster that 2 l/s</span>
        <span class="n">Qin_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">Qin_clip</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qin</span>     <span class="o">=</span> <span class="n">Qin_clip</span>                    <span class="c1"># Assume the set-value is also the true value for prop</span></div>

<div class="viewcode-block" id="Balloon_Simulator.set_flow_out"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.Balloon_Simulator.set_flow_out">[docs]</a>    <span class="k">def</span> <span class="nf">set_flow_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Qout</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qout</span> <span class="o">=</span> <span class="n">Qout</span>

        <span class="n">Qout_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">Qout</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>                    <span class="c1"># Flows have to be positive, and reasonable. Nothing here is faster that 2 l/s</span>
        <span class="n">Qout_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">Qout_clip</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">difference_pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">-</span> <span class="mi">0</span>  <span class="c1"># Convention: outside is &quot;0&quot;</span>
        <span class="n">conductance</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">Qout_clip</span>                     <span class="c1"># This should be in the range of ~1 liter/s for typical max pressure differences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span> <span class="o">=</span> <span class="n">difference_pressure</span> <span class="o">*</span> <span class="n">conductance</span>    <span class="c1"># Target for flow out</span></div>

<div class="viewcode-block" id="Balloon_Simulator.update"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.Balloon_Simulator.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>  <span class="c1"># Performs an update of duration dt [seconds]</span>

        <span class="k">if</span> <span class="n">dt</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>                                        <span class="c1"># This is the simulation, so not quite so important,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qin</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span>     <span class="c1"># But no update should take longer than that</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_flow</span> <span class="o">*</span> <span class="n">dt</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">leak</span><span class="p">:</span>
                <span class="n">RC</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># pulled 5 sec out of my hat</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">RC</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">+</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span><span class="p">)</span>

            <span class="c1"># This is from the baloon equation, uses helper variable (the baloon radius)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">r0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P0</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span> <span class="o">/</span> <span class="p">(</span><span class="n">r0</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span><span class="p">)</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span>

            <span class="c1"># Temperature, humidity and o2 fluctuations modelled as OUprocess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUupdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fio2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUupdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fio2</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">humidity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUupdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">humidity</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">humidity</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">humidity</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span><span class="p">)</span></div>


<div class="viewcode-block" id="Balloon_Simulator.OUupdate"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.Balloon_Simulator.OUupdate">[docs]</a>    <span class="k">def</span> <span class="nf">OUupdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This is a simple function to produce an OU process.</span>
<span class="sd">        It is used as model for fluctuations in measurement variables.</span>
<span class="sd">        inputs:</span>
<span class="sd">        variable:   float     value at previous time step</span>
<span class="sd">        dt      :   timestep</span>
<span class="sd">        mu      :   mean</span>
<span class="sd">        sigma   :   noise amplitude</span>
<span class="sd">        tau     :   time scale</span>
<span class="sd">        returns:</span>
<span class="sd">        new_variable :  value of &quot;variable&quot; at next time step</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>  <span class="c1">#Make sure this doesn&#39;t go haywire if anything hangs. Max 50ms</span>
        <span class="n">sigma_bis</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">sqrtdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">new_variable</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">variable</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma_bis</span> <span class="o">*</span> <span class="n">sqrtdt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_variable</span></div>

<div class="viewcode-block" id="Balloon_Simulator._reset"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.Balloon_Simulator._reset">[docs]</a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; resets the ballon to standard parameters. &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qin</span>          <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qin</span>              <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Qout</span>         <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qout</span>             <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_pressure</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_real</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_volume</span></div></div>

<div class="viewcode-block" id="ControlModuleSimulator"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleSimulator">[docs]</a><span class="k">class</span> <span class="nc">ControlModuleSimulator</span><span class="p">(</span><span class="n">ControlModuleBase</span><span class="p">):</span>
    <span class="c1"># Implement ControlModuleBase functions</span>
<div class="viewcode-block" id="ControlModuleSimulator.__init__"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleSimulator.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulator_dt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            simulator_dt (None, float): if None, simulate dt at same rate controller updates.</span>
<span class="sd">                if ``float`` , fix dt updates with this value but still update at _LOOP_UPDATE_TIME</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ControlModuleBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span> <span class="o">=</span> <span class="n">Balloon_Simulator</span><span class="p">(</span><span class="n">leak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>          <span class="c1"># This is the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simulator_dt</span> <span class="o">=</span> <span class="n">simulator_dt</span></div>

    <span class="k">def</span> <span class="nf">__SimulatedPropValve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This simulates the action of a proportional valve.</span>
<span class="sd">        Flow-current-curve eye-balled from the datasheet of SMC PVQ31-5G-23-01N  </span>
<span class="sd">        https://www.ocpneumatics.com/content/pdfs/PVQ.pdf</span>
<span class="sd">        </span>
<span class="sd">        x:  Input current [mA]</span>
<span class="sd">        dt: Time since last setting in seconds [for the LP filter]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">flow_new</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mf">0.03</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">130</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">&gt;</span><span class="mi">160</span><span class="p">:</span>
            <span class="n">flow_new</span> <span class="o">=</span> <span class="mf">1.72</span>  <span class="c1">#Maximum, ~100 l/min</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">flow_new</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">flow_new</span>

    <span class="k">def</span> <span class="nf">__SimulatedSolenoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Depending on x, set flow to a binary value.</span>
<span class="sd">        Here: flow is either 0 or 1l/sec</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="ControlModuleSimulator._sensor_to_COPY"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleSimulator._sensor_to_COPY">[docs]</a>    <span class="k">def</span> <span class="nf">_sensor_to_COPY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># And the sensor measurements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COPY_sensor_values</span> <span class="o">=</span> <span class="n">SensorValues</span><span class="p">(</span><span class="n">vals</span><span class="o">=</span><span class="p">{</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">PIP</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PIP</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">PEEP</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PEEP</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">FIO2</span><span class="o">.</span><span class="n">name</span>                 <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">fio2</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">PRESSURE</span><span class="o">.</span><span class="n">name</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">current_pressure</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">VTE</span><span class="o">.</span><span class="n">name</span>                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_VTE</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">BREATHS_PER_MINUTE</span><span class="o">.</span><span class="n">name</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BPM</span><span class="p">,</span>
            <span class="n">ValueName</span><span class="o">.</span><span class="n">INSPIRATION_TIME_SEC</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_I_PHASE</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span>                  <span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="s1">&#39;loop_counter&#39;</span>             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span><span class="p">,</span>
            <span class="s1">&#39;breath_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_BREATH_COUNT</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="ControlModuleSimulator._start_mainloop"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.ControlModuleSimulator._start_mainloop">[docs]</a>    <span class="k">def</span> <span class="nf">_start_mainloop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># start running, this should be run as a thread! </span>
        <span class="c1"># Compare to initialization in Base Class!</span>

        <span class="n">update_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator_dt</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator_dt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span>                            <span class="c1"># Time sincle last cycle of main-loop</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>                                            <span class="c1"># TODO: RAISE HARDWARE ALARM, no update should take longer than 0.5 sec</span>
                    <span class="c1"># TODO: Log this</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restarted cycle.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_PID_reset</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOOP_UPDATE_TIME</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>                            <span class="c1"># Update the state of the balloon simulation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_PRESSURE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">get_pressure</span><span class="p">()</span>       <span class="c1"># Get a pressure measurement from balloon and tell controller             --- SENSOR 1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_PID_update</span><span class="p">(</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>                               <span class="c1"># Update the PID Controller</span>

            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_control_signal_in</span><span class="p">()</span>                       <span class="c1"># Inspiratory side: get control signal for PropValve</span>
            <span class="n">Qin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SimulatedPropValve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>             <span class="c1"># And calculate the produced flow Qin</span>

            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_control_signal_out</span><span class="p">()</span>                      <span class="c1"># Expiratory side: get control signal for Solenoid</span>
            <span class="n">Qout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__SimulatedSolenoid</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>                      <span class="c1"># Set expiratory flow rate, Qout</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">set_flow_in</span><span class="p">(</span><span class="n">Qin</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>                  <span class="c1"># Set the flow rates for the Balloon simulator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">set_flow_out</span><span class="p">(</span><span class="n">Qout</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">Qout</span>                     <span class="c1"># Tell controller the expiratory flow rate, _DATA_Qout                    --- SENSOR 2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_Qin</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Balloon</span><span class="o">.</span><span class="n">Qin</span>                      <span class="c1"># Tell controller the expiratory flow rate, _DATA_Qin                     --- SENSOR 3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_update</span> <span class="o">=</span> <span class="n">now</span>

            <span class="k">if</span> <span class="n">update_copies</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_controls_from_COPY</span><span class="p">()</span>     <span class="c1"># Update controls from possibly updated values as a chunk</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_alarm_to_COPY</span><span class="p">()</span>          <span class="c1"># Copy current alarms and settings to COPY</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>         <span class="c1"># Copy sensor values to COPY</span>
                <span class="n">update_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NUMBER_CONTROLL_LOOPS_UNTIL_UPDATE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_copies</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># # get final values on stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controls_from_COPY</span><span class="p">()</span>  <span class="c1"># Update controls from possibly updated values as a chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alarm_to_COPY</span><span class="p">()</span>  <span class="c1"># Copy current alarms and settings to COPY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_to_COPY</span><span class="p">()</span>  <span class="c1"># Copy sensor values to COPY</span></div></div>




<div class="viewcode-block" id="get_control_module"><a class="viewcode-back" href="../../../vent.controller.html#vent.controller.control_module.get_control_module">[docs]</a><span class="k">def</span> <span class="nf">get_control_module</span><span class="p">(</span><span class="n">sim_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simulator_dt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sim_mode</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ControlModuleSimulator</span><span class="p">(</span><span class="n">simulator_dt</span><span class="o">=</span><span class="n">simulator_dt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ControlModuleDevice</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, jonny saunders et al

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>